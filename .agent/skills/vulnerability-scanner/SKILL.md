---
name: vulnerability-scanner
description: Security vulnerability scanning and OWASP compliance checking. Use for security audits, pre-deployment checks, and vulnerability analysis.
---

# Vulnerability Scanner Skill

> Systematic security vulnerability detection and remediation.

## When to Activate

- Pre-deployment security audits
- Reviewing authentication/authorization code
- After adding payment or PII handling
- Quarterly security assessments
- Dependency vulnerability checks

## Automated Scanning Commands

### Dependency Vulnerabilities
```bash
# npm audit (built-in)
npm audit
npm audit --json > audit-report.json

# Auto-fix what's possible
npm audit fix
npm audit fix --force  # For breaking changes

# Snyk (comprehensive)
npx snyk test
npx snyk test --json > snyk-report.json

# OWASP Dependency Check
npx owasp-dependency-check --project "MyApp" --scan .
```

### Secret Detection
```bash
# Gitleaks (pre-commit)
gitleaks detect --source=. -v

# TruffleHog (git history)
trufflehog git file://. --json > secrets-report.json

# Manual grep for common patterns
grep -rn "password\s*[=:]\s*['\"]" --include="*.ts" --include="*.js" .
grep -rn "api[_-]?key\s*[=:]\s*['\"]" --include="*.ts" --include="*.js" .
grep -rn "secret\s*[=:]\s*['\"]" --include="*.ts" --include="*.js" .
grep -rn "AKIA[0-9A-Z]{16}" .  # AWS Access Keys
grep -rn "ghp_[a-zA-Z0-9]{36}" .  # GitHub PATs
```

### Static Analysis
```bash
# ESLint security plugin
npm install --save-dev eslint-plugin-security
npx eslint --plugin security --rule 'security/detect-object-injection: error' .

# Semgrep (pattern-based)
semgrep --config=auto .
semgrep --config=p/owasp-top-ten .
```

## Manual Security Checklist

### A01: Broken Access Control
```markdown
[ ] Every API endpoint requires authentication
[ ] Authorization checked on every request
[ ] No direct object references (IDOR)
[ ] CORS properly configured
[ ] Rate limiting implemented
[ ] File uploads restricted
```

### A02: Cryptographic Failures
```markdown
[ ] TLS 1.2+ enforced
[ ] Strong algorithms (AES-256, RSA-2048+)
[ ] Passwords hashed with bcrypt/argon2
[ ] No sensitive data in URLs
[ ] Secrets in environment variables
[ ] No MD5/SHA1 for security
```

### A03: Injection
```markdown
[ ] Parameterized SQL queries
[ ] Input validation (whitelist)
[ ] Output encoding
[ ] No eval() with user input
[ ] Command injection prevention
[ ] NoSQL injection prevention
```

### A07: XSS Prevention
```markdown
[ ] HTML sanitization (DOMPurify)
[ ] React uses JSX escaping
[ ] CSP headers configured
[ ] HttpOnly cookies
[ ] No dangerouslySetInnerHTML without sanitization
```

## Vulnerability Detection Patterns

### SQL Injection Detection
```bash
# String concatenation in queries
grep -rn "query.*\`.*\$\{" --include="*.ts" .
grep -rn "execute.*\`.*\$\{" --include="*.ts" .
grep -rn "\.raw\s*\(" --include="*.ts" .

# Vulnerable patterns
# ‚ùå const query = `SELECT * FROM users WHERE id = '${userId}'`
# ‚úÖ const query = 'SELECT * FROM users WHERE id = $1', [userId]
```

### XSS Detection
```bash
# dangerouslySetInnerHTML
grep -rn "dangerouslySetInnerHTML" --include="*.tsx" .

# innerHTML assignment
grep -rn "\.innerHTML\s*=" --include="*.ts" .

# document.write
grep -rn "document\.write" --include="*.ts" .
```

### Command Injection Detection
```bash
# exec/spawn with user input
grep -rn "exec\s*(" --include="*.ts" .
grep -rn "spawn\s*(" --include="*.ts" .
grep -rn "execSync\s*(" --include="*.ts" .
```

### Hardcoded Secrets
```bash
# Common patterns
grep -rn "password\s*[:=]\s*['\"][^'\"]*['\"]" --include="*.ts" .
grep -rn "Bearer\s*['\"][^'\"]*['\"]" --include="*.ts" .
grep -rn "sk_live_" --include="*.ts" .  # Stripe
grep -rn "pk_live_" --include="*.ts" .  # Stripe
```

## Common Vulnerabilities & Fixes

### SQL Injection
```typescript
// ‚ùå VULNERABLE
const query = `SELECT * FROM users WHERE email = '${email}'`;

// ‚úÖ FIXED: Parameterized query
const query = 'SELECT * FROM users WHERE email = $1';
await db.query(query, [email]);

// ‚úÖ FIXED: ORM
await prisma.user.findUnique({ where: { email } });
```

### XSS
```typescript
// ‚ùå VULNERABLE
<div dangerouslySetInnerHTML={{ __html: userInput }} />

// ‚úÖ FIXED: Sanitize
import DOMPurify from 'dompurify';
<div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(userInput) }} />

// ‚úÖ BETTER: Don't use dangerouslySetInnerHTML
<div>{userInput}</div>
```

### Path Traversal
```typescript
// ‚ùå VULNERABLE
const filePath = path.join('/uploads', req.params.filename);
fs.readFile(filePath);

// ‚úÖ FIXED: Validate path
const filename = path.basename(req.params.filename);
const filePath = path.join('/uploads', filename);

if (!filePath.startsWith('/uploads/')) {
  throw new Error('Invalid path');
}
```

### IDOR (Insecure Direct Object Reference)
```typescript
// ‚ùå VULNERABLE: No ownership check
app.get('/documents/:id', async (req, res) => {
  const doc = await db.document.findUnique({ where: { id: req.params.id } });
  return res.json(doc);
});

// ‚úÖ FIXED: Verify ownership
app.get('/documents/:id', async (req, res) => {
  const doc = await db.document.findUnique({
    where: { 
      id: req.params.id,
      userId: req.user.id  // Ownership check
    }
  });
  if (!doc) return res.status(404).json({ error: 'Not found' });
  return res.json(doc);
});
```

## Security Headers

```typescript
// Express middleware
app.use((req, res, next) => {
  // Prevent MIME sniffing
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // Clickjacking protection
  res.setHeader('X-Frame-Options', 'DENY');
  
  // XSS filter
  res.setHeader('X-XSS-Protection', '1; mode=block');
  
  // HTTPS enforcement
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  
  // CSP
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  
  // Referrer policy
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  next();
});
```

## Vulnerability Report Format

```markdown
# Vulnerability Scan Report

**Project:** [Name]
**Date:** [Date]
**Scan Type:** [Automated/Manual/Both]

## Executive Summary

| Severity | Count |
|----------|-------|
| üî¥ Critical | X |
| üü† High | X |
| üü° Medium | X |
| üü¢ Low | X |
| ‚ÑπÔ∏è Info | X |

## Findings

### üî¥ CRITICAL-001: SQL Injection in User Search
**File:** `src/api/users.ts:45`
**CVSS:** 9.8
**Description:** User input directly concatenated into SQL query.
**Impact:** Full database access, data exfiltration.
**Remediation:**
```typescript
// Before
const query = `SELECT * FROM users WHERE name LIKE '%${search}%'`;

// After
const query = 'SELECT * FROM users WHERE name LIKE $1';
await db.query(query, [`%${search}%`]);
```

## Recommendations
1. Implement parameterized queries throughout
2. Add CSP headers
3. Enable npm audit in CI/CD
4. Schedule quarterly security reviews
```

## CI/CD Integration

```yaml
# .github/workflows/security.yml
name: Security Scan

on: [push, pull_request]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run npm audit
        run: npm audit --audit-level=high
        
      - name: Run Snyk
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```
