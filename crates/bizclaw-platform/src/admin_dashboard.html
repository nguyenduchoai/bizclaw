<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BizClaw â€” Admin Platform</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%2312161e'/%3E%3Ctext x='50' y='70' font-size='55' text-anchor='middle'%3E%F0%9F%8F%A2%3C/text%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e14;--surface:#12161e;--border:#1e2533;--text:#e6edf3;--muted:#6b7a8d;--accent:#58a6ff;--green:#3fb950;--red:#f85149;--yellow:#d29922;--card:#161d28;--purple:#bc8cff;--cyan:#56d4dd;--orange:#f0883e;--glass:rgba(22,29,40,0.85);--glow:0 0 20px rgba(88,166,255,0.08)}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* â”€â”€ Sidebar â”€â”€ */
.sidebar{width:230px;background:var(--surface);border-right:1px solid var(--border);padding:20px 0;display:flex;flex-direction:column;position:relative;z-index:10}
.sidebar::after{content:'';position:absolute;right:0;top:0;bottom:0;width:1px;background:linear-gradient(180deg,transparent,rgba(88,166,255,0.15),transparent)}
.sidebar .logo{padding:0 20px 16px;border-bottom:1px solid var(--border);margin-bottom:8px}
.sidebar .logo h2{font-size:18px;color:var(--accent);font-weight:700;letter-spacing:-0.3px}
.sidebar .logo p{font-size:11px;color:var(--muted);margin-top:2px}
.sidebar .logo .version-badge{display:inline-block;font-size:9px;padding:2px 6px;background:rgba(88,166,255,0.12);color:var(--accent);border-radius:4px;margin-left:6px;font-weight:600;vertical-align:middle}
.sidebar .logo .health-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);margin-left:6px;vertical-align:middle;box-shadow:0 0 6px var(--green);animation:healthPulse 2s ease-in-out infinite}
@keyframes healthPulse{0%,100%{opacity:1;box-shadow:0 0 4px var(--green)}50%{opacity:0.6;box-shadow:0 0 10px var(--green)}}
.sidebar a{display:flex;align-items:center;padding:10px 20px;color:var(--muted);text-decoration:none;font-size:13px;gap:10px;transition:all .2s;cursor:pointer;position:relative;border-left:2px solid transparent}
.sidebar a:hover{background:rgba(88,166,255,0.05);color:var(--text)}
.sidebar a.active{background:rgba(88,166,255,0.08);color:var(--accent);border-left-color:var(--accent);font-weight:500}
.sidebar a .nav-icon{font-size:16px;flex-shrink:0;width:22px;text-align:center}
.sidebar .bottom{margin-top:auto;padding:10px 20px;border-top:1px solid var(--border)}
.sidebar .bottom a{padding:5px 0;font-size:12px}
.sidebar .bottom .shortcut-hint{font-size:10px;color:var(--border);margin-top:6px;letter-spacing:0.3px}

/* â”€â”€ Main area â”€â”€ */
.main{flex:1;padding:30px 36px;overflow-y:auto;background:var(--bg)}
.main h1{font-size:22px;margin-bottom:22px;display:flex;align-items:center;gap:10px;font-weight:600;letter-spacing:-0.3px}

/* â”€â”€ Stats cards with gradient â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:25px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 20px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.stat:hover{transform:translateY(-2px);box-shadow:var(--glow)}
.stat::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:12px 12px 0 0}
.stat:nth-child(1)::before{background:linear-gradient(90deg,var(--accent),var(--cyan))}
.stat:nth-child(2)::before{background:linear-gradient(90deg,var(--green),#2ea043)}
.stat:nth-child(3)::before{background:linear-gradient(90deg,var(--yellow),var(--orange))}
.stat:nth-child(4)::before{background:linear-gradient(90deg,var(--red),#da3633)}
.stat:nth-child(5)::before{background:linear-gradient(90deg,var(--purple),var(--accent))}
.stat label{font-size:11px;color:var(--muted);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;font-weight:500}
.stat .val{font-size:28px;font-weight:700;letter-spacing:-1px}
.stat .val.green{color:var(--green)}.stat .val.red{color:var(--red)}

/* â”€â”€ Grid & Card â”€â”€ */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;transition:border-color .2s}
.card:hover{border-color:rgba(88,166,255,0.2)}
.card h3{font-size:13px;margin-bottom:12px;display:flex;justify-content:space-between;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;color:var(--muted)}
.card h3 a{color:var(--accent);font-size:11px;text-decoration:none;cursor:pointer;text-transform:none;letter-spacing:0;font-weight:500}
.card h3 a:hover{text-decoration:underline}

/* â”€â”€ Tenant rows â”€â”€ */
.tenant-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);transition:background .15s}
.tenant-row:last-child{border:none}
.tenant-row:hover{background:rgba(88,166,255,0.03);margin:0 -8px;padding:10px 8px;border-radius:6px}
.tenant-name{color:var(--accent);font-weight:500;cursor:pointer}
.tenant-slug{color:var(--muted);font-size:12px}

/* â”€â”€ Badges â”€â”€ */
.badge{padding:3px 10px;border-radius:10px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.badge.running{background:rgba(63,185,80,0.12);color:var(--green);border:1px solid rgba(63,185,80,0.2)}
.badge.stopped{background:rgba(139,148,158,0.08);color:var(--muted);border:1px solid rgba(139,148,158,0.15)}
.badge.error{background:rgba(248,81,73,0.12);color:var(--red);border:1px solid rgba(248,81,73,0.2)}
.badge.connected{background:rgba(63,185,80,0.12);color:var(--green);border:1px solid rgba(63,185,80,0.2)}
.badge.disconnected{background:rgba(139,148,158,0.08);color:var(--muted);border:1px solid rgba(139,148,158,0.15)}

/* â”€â”€ Events â”€â”€ */
.event{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.event:last-child{border:none}
.event .type{font-weight:500}.event .meta{color:var(--muted);font-size:11px}
.event .time{color:var(--muted);font-size:11px;white-space:nowrap}

/* â”€â”€ Buttons â”€â”€ */
.btn{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;transition:all .15s;font-family:inherit}
.btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
.btn:active{transform:translateY(0);filter:brightness(0.95)}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(88,166,255,0.2)}
.btn-danger{background:var(--red);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-green{background:var(--green);color:#fff}.btn-purple{background:var(--purple);color:#000}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:6px}
.hidden{display:none!important}

/* â”€â”€ Modals with glass effect â”€â”€ */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:100;animation:overlayIn .2s}
@keyframes overlayIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;min-width:400px;max-width:720px;max-height:85vh;overflow-y:auto;animation:modalIn .25s cubic-bezier(.22,1,.36,1);box-shadow:0 20px 60px rgba(0,0,0,.5)}
@keyframes modalIn{from{opacity:0;transform:scale(0.96) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal h2{margin-bottom:15px;display:flex;align-items:center;gap:8px;font-size:18px}
.modal label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px;margin-top:10px}
.modal input,.modal select,.modal textarea{width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit;transition:border-color .15s}
.modal input:focus,.modal select:focus,.modal textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(88,166,255,0.1)}
.modal textarea{resize:vertical;min-height:60px;font-family:'Menlo','Courier New',monospace;font-size:12px}
.modal .actions{display:flex;gap:10px;margin-top:20px;justify-content:flex-end}

/* â”€â”€ Channel config cards â”€â”€ */
.ch-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.ch-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;transition:all .2s}
.ch-card:hover{border-color:rgba(88,166,255,0.25);box-shadow:var(--glow)}
.ch-card .ch-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.ch-card .ch-icon{font-size:22px}
.ch-card .ch-name{font-weight:600;font-size:14px}
.ch-card .ch-status{font-size:11px;padding:2px 8px;border-radius:8px}
.ch-card .ch-fields{font-size:12px;color:var(--muted)}
.ch-card input,.ch-card textarea{margin-top:6px;width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;font-family:inherit;transition:border-color .15s}
.ch-card input:focus,.ch-card textarea:focus{outline:none;border-color:var(--accent)}
.ch-card textarea{font-family:'Menlo','Courier New',monospace;min-height:50px;resize:vertical}
.ch-card .ch-actions{display:flex;gap:6px;margin-top:10px}
.toggle{position:relative;display:inline-block;width:38px;height:20px}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:20px;transition:.3s}
.toggle .slider:before{content:'';position:absolute;height:14px;width:14px;left:3px;bottom:3px;background:var(--text);border-radius:50%;transition:.3s}
.toggle input:checked+.slider{background:var(--green)}
.toggle input:checked+.slider:before{transform:translateX(18px)}
.qr-container{text-align:center;padding:15px}
.qr-container img{max-width:200px;border-radius:8px;border:2px solid var(--accent)}
.qr-container p{font-size:12px;color:var(--muted);margin-top:8px}

/* â”€â”€ Toast (stacking) â”€â”€ */
#toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:rgba(63,185,80,0.95);color:#fff;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;animation:toastIn .3s cubic-bezier(.22,1,.36,1),toastOut .3s 2.5s forwards;backdrop-filter:blur(8px);box-shadow:0 8px 24px rgba(0,0,0,.3);pointer-events:auto}
.toast.error{background:rgba(248,81,73,0.95)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}

/* â”€â”€ Loading skeleton â”€â”€ */
.skeleton{background:linear-gradient(90deg,var(--card) 25%,var(--border) 50%,var(--card) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:6px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-stat{height:72px;border-radius:12px}
.skeleton-row{height:48px;margin-bottom:8px;border-radius:8px}
.skeleton-card{height:120px;border-radius:12px}

/* â”€â”€ Page transitions â”€â”€ */
.page-enter{animation:pageIn .25s ease-out}
@keyframes pageIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ Search bar â”€â”€ */
.search-bar{position:relative;margin-bottom:16px}
.search-bar input{width:100%;padding:10px 14px 10px 36px;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;font-family:inherit;transition:all .2s}
.search-bar input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(88,166,255,0.1)}
.search-bar input::placeholder{color:var(--muted)}
.search-bar .search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--muted)}
.search-bar .search-shortcut{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:10px;color:var(--border);background:var(--card);padding:2px 6px;border-radius:4px;border:1px solid var(--border)}

/* â”€â”€ Provider icons â”€â”€ */
.provider-icon{display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 8px;border-radius:6px;font-weight:500}
.provider-icon.openai{background:rgba(116,204,143,0.1);color:#74cc8c}
.provider-icon.anthropic{background:rgba(204,145,100,0.1);color:#cc9164}
.provider-icon.ollama{background:rgba(88,166,255,0.1);color:var(--accent)}
.provider-icon.gemini{background:rgba(188,140,255,0.1);color:var(--purple)}
.provider-icon.deepseek{background:rgba(86,212,221,0.1);color:var(--cyan)}
.provider-icon.groq{background:rgba(240,136,62,0.1);color:var(--orange)}
.provider-icon.brain{background:rgba(248,81,73,0.1);color:var(--red)}
.provider-icon.llamacpp{background:rgba(210,153,34,0.1);color:var(--yellow)}

/* â”€â”€ Teams / Workflows page â”€â”€ */
.teams-templates{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:24px}
.team-tpl{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;position:relative;overflow:hidden;transition:all .3s;cursor:pointer}
.team-tpl:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(88,166,255,0.12);border-color:rgba(88,166,255,0.3)}
.team-tpl::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.team-tpl.tpl-feat::before{background:linear-gradient(90deg,#6C5CE7,#a29bfe)}
.team-tpl.tpl-bug::before{background:linear-gradient(90deg,#f85149,#ff6b6b)}
.team-tpl.tpl-sec::before{background:linear-gradient(90deg,#fdcb6e,#f39c12)}
.team-tpl.tpl-content::before{background:linear-gradient(90deg,#00b894,#55efc4)}
.team-tpl.tpl-review::before{background:linear-gradient(90deg,#58a6ff,#56d4dd)}
.team-tpl.tpl-support::before{background:linear-gradient(90deg,#bc8cff,#e17bff)}
.team-tpl .tpl-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.team-tpl .tpl-icon{font-size:28px}
.team-tpl .tpl-title{font-size:16px;font-weight:600}
.team-tpl .tpl-agents{font-size:11px;color:var(--accent);background:rgba(88,166,255,0.1);padding:2px 8px;border-radius:8px;margin-left:auto}
.team-tpl .tpl-desc{font-size:13px;color:var(--muted);line-height:1.5;margin-bottom:14px}
.team-tpl .tpl-pipeline{display:flex;align-items:center;gap:0;flex-wrap:wrap}
.team-tpl .pipe-step{font-size:10px;padding:4px 10px;background:var(--card);border:1px solid var(--border);border-radius:20px;color:var(--text);white-space:nowrap;transition:all .2s}
.team-tpl:hover .pipe-step{border-color:rgba(88,166,255,0.3)}
.team-tpl .pipe-arrow{font-size:10px;color:var(--border);padding:0 2px}

/* Team runs */
.team-runs{margin-top:16px}
.run-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:12px;transition:all .2s}
.run-card:hover{border-color:rgba(88,166,255,0.2)}
.run-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.run-id{font-family:'Menlo','Courier New',monospace;font-size:12px;color:var(--accent)}
.run-steps{display:flex;gap:0;align-items:center;flex-wrap:wrap}
.run-step{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-size:12px;background:var(--card);border:1px solid var(--border);transition:all .3s}
.run-step.done{background:rgba(63,185,80,0.08);border-color:rgba(63,185,80,0.25);color:var(--green)}
.run-step.running{background:rgba(88,166,255,0.08);border-color:rgba(88,166,255,0.3);color:var(--accent);animation:stepPulse 1.5s ease-in-out infinite}
.run-step.failed{background:rgba(248,81,73,0.08);border-color:rgba(248,81,73,0.25);color:var(--red)}
.run-step.pending{color:var(--muted)}
.run-arrow{font-size:10px;color:var(--border);padding:0 3px}
@keyframes stepPulse{0%,100%{opacity:1}50%{opacity:0.6}}
.run-progress{height:4px;background:var(--border);border-radius:4px;margin-top:12px;overflow:hidden}
.run-progress-bar{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--accent));transition:width .5s}

/* Team detail modal */
.team-agents-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin:16px 0}
.agent-role-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;transition:all .2s}
.agent-role-card:hover{border-color:rgba(88,166,255,0.3);transform:scale(1.02)}
.agent-role-card .role-icon{font-size:32px;display:block;margin-bottom:6px}
.agent-role-card .role-name{font-weight:600;font-size:14px}
.agent-role-card .role-type{font-size:11px;color:var(--muted);margin-top:2px}
.agent-role-card .role-access{font-size:10px;margin-top:6px;padding:3px 8px;border-radius:6px;display:inline-block}
.agent-role-card .role-access.analysis{background:rgba(88,166,255,0.1);color:var(--accent)}
.agent-role-card .role-access.coding{background:rgba(63,185,80,0.1);color:var(--green)}
.agent-role-card .role-access.verification{background:rgba(210,153,34,0.1);color:var(--yellow)}
.agent-role-card .role-access.testing{background:rgba(188,140,255,0.1);color:var(--purple)}
.agent-role-card .role-access.scanning{background:rgba(240,136,62,0.1);color:var(--orange)}

/* Active teams list */
.active-team{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;transition:all .2s}
.active-team:hover{border-color:rgba(88,166,255,0.2)}
.active-team .team-info{display:flex;align-items:center;gap:12px}
.active-team .team-icon{font-size:20px}
.active-team .team-name{font-weight:600;font-size:14px}
.active-team .team-meta{font-size:11px;color:var(--muted)}
.active-team .team-actions{display:flex;gap:6px}

/* Responsive */
@media(max-width:768px){.sidebar{width:60px}.sidebar a span:not(.nav-icon),.sidebar .logo p,.sidebar .bottom .shortcut-hint,.sidebar .logo .version-badge{display:none}.grid{grid-template-columns:1fr}.ch-grid{grid-template-columns:1fr}.main{padding:20px 16px}.teams-templates{grid-template-columns:1fr}.team-agents-grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<aside class="sidebar">
  <div class="logo">
    <h2>BizClaw <span class="version-badge">v0.2</span> <span class="health-dot" id="sidebar-health" title="Platform healthy"></span></h2>
    <p>Admin Platform</p>
  </div>
  <a class="active" href="#/dashboard" data-page="dashboard"><span class="nav-icon">ğŸ“Š</span> <span>Dashboard</span></a>
  <a href="#/tenants" data-page="tenants"><span class="nav-icon">ğŸ¢</span> <span>Tenants</span></a>
  <a href="#/users" data-page="users"><span class="nav-icon">ğŸ‘¥</span> <span>Users</span></a>
  <a href="#/teams" data-page="teams"><span class="nav-icon">ğŸœ</span> <span>Agent Teams</span></a>
  <a href="#/audit" data-page="audit"><span class="nav-icon">ğŸ“‹</span> <span>Audit Log</span></a>
  <a href="#/ollama" data-page="ollama"><span class="nav-icon">ğŸ§ </span> <span>Ollama</span></a>
  <a href="#/profile" data-page="profile"><span class="nav-icon">ğŸ‘¤</span> <span>Profile</span></a>
  <div class="bottom">
    <a href="#" onclick="logout()">â Logout</a>
    <div class="shortcut-hint">âŒ˜K Search Â· Esc Close</div>
  </div>
</aside>

<!-- Login Screen -->
<div id="login-screen" style="position:fixed;inset:0;background:var(--bg);z-index:300;display:flex;align-items:center;justify-content:center">
  <div style="width:420px">
    <!-- Credentials Banner â€” prominent, above login -->

    <!-- Login Form -->
    <div id="login-form-box" style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px 36px;text-align:center">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:20px">ğŸ¢ BizClaw Admin</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">ÄÄƒng nháº­p Ä‘á»ƒ quáº£n lÃ½ há»‡ thá»‘ng</p>
      <div id="login-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
      <input id="login-email" type="text" inputmode="email" autocomplete="email" placeholder="Email" style="width:100%;padding:10px 14px;margin-bottom:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
      <input id="login-password" type="password" placeholder="Password" style="width:100%;padding:10px 14px;margin-bottom:16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px" onclick="doLogin()">ğŸ”‘ ÄÄƒng nháº­p</button>
      <div style="margin-top:16px;font-size:13px;color:var(--muted);text-align:center">
        <a href="#" onclick="showAuthBox('forgot-form-box')" style="color:var(--muted)">QuÃªn máº­t kháº©u?</a>
      </div>
    </div>

    <!-- Register Form â€” TEMPORARILY DISABLED
    <div id="register-form-box" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px 36px;text-align:center">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:20px">ğŸ¢ ÄÄƒng kÃ½ Cloud</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">Táº¡o ngay má»™t mÃ´i trÆ°á»ng quáº£n lÃ½ AI tá»± Ä‘á»™ng</p>
      <div id="register-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
      <input id="register-company" type="text" placeholder="TÃªn cÃ´ng ty (VÃ­ dá»¥: Vinamilk)" style="width:100%;padding:10px 14px;margin-bottom:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
      <input id="register-email" type="text" inputmode="email" autocomplete="email" placeholder="Email quáº£n trá»‹" style="width:100%;padding:10px 14px;margin-bottom:10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
      <input id="register-password" type="password" placeholder="Máº­t kháº©u (Ã­t nháº¥t 6 kÃ½ tá»±)" style="width:100%;padding:10px 14px;margin-bottom:16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')doRegister()">
      <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px" onclick="doRegister()">ğŸš€ Khá»Ÿi táº¡o há»‡ thá»‘ng</button>
      <div style="margin-top:16px;font-size:13px;color:var(--muted)">
        ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" onclick="showAuthBox('login-form-box')" style="color:var(--accent)">ÄÄƒng nháº­p</a>
      </div>
    </div>
    -->

    <!-- Forgot Password Form -->
    <div id="forgot-form-box" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px 36px;text-align:center">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:20px">Láº¥y láº¡i máº­t kháº©u</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">Nháº­p email Ä‘á»ƒ nháº­n link reset</p>
      <div id="forgot-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
      <input id="forgot-email" type="text" inputmode="email" autocomplete="email" placeholder="Email" style="width:100%;padding:10px 14px;margin-bottom:16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')doForgotPassword()">
      <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px" onclick="doForgotPassword()">Gá»­i link</button>
      <div style="margin-top:16px;font-size:13px;color:var(--muted)">
        <a href="#" onclick="showAuthBox('login-form-box')" style="color:var(--accent)">Quay láº¡i Ä‘Äƒng nháº­p</a>
      </div>
    </div>

    <!-- Reset Password Form -->
    <div id="reset-form-box" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:32px 36px;text-align:center">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:20px">Äáº·t láº¡i máº­t kháº©u</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">Nháº­p máº­t kháº©u má»›i cho tÃ i khoáº£n</p>
      <div id="reset-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
      <input id="reset-password-input" type="password" placeholder="Máº­t kháº©u má»›i" style="width:100%;padding:10px 14px;margin-bottom:16px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')doResetPassword()">
      <button class="btn btn-primary" style="width:100%;padding:12px;font-size:14px" onclick="doResetPassword()">Cáº­p nháº­t</button>
    </div>
  </div>
</div>

<main class="main">
  <!-- Dashboard -->
  <div id="page-dashboard">
    <h1>ğŸ“Š Dashboard</h1>
    <div class="stats" id="stats-row">
      <div class="stat skeleton skeleton-stat"></div>
      <div class="stat skeleton skeleton-stat"></div>
      <div class="stat skeleton skeleton-stat"></div>
      <div class="stat skeleton skeleton-stat"></div>
      <div class="stat skeleton skeleton-stat"></div>
    </div>
    <div class="grid">
      <div class="card"><h3>âš¡ Tenant Health <a href="#" onclick="showPage('tenants')">View all â†’</a></h3><div id="health-list"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
      <div class="card"><h3>ğŸ“‹ Recent Activity <a href="#" onclick="showPage('audit')">View all â†’</a></h3><div id="activity-list"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div>
    </div>
  </div>
  
  <!-- Profile Page -->
  <div id="page-profile" class="hidden">
    <h1>ğŸ‘¤ My Profile</h1>
    <div class="card" style="max-width:500px;margin-top:16px">
      <h3>Change Password</h3>
      <div id="profile-msg" style="display:none;margin-bottom:12px;padding:12px;border-radius:6px;font-size:13px"></div>
      <div style="margin-top:12px">
        <label style="display:block;margin-bottom:6px;color:var(--text2);font-size:13px">Current Password</label>
        <input type="password" id="profile-current-pwd" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:16px">
        
        <label style="display:block;margin-bottom:6px;color:var(--text2);font-size:13px">New Password</label>
        <input type="password" id="profile-new-pwd" style="width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);margin-bottom:16px">
      </div>
      <button class="btn btn-primary" onclick="doChangePassword()">Cáº­p nháº­t thay Ä‘á»•i</button>
    </div>
  </div>

  <!-- Tenants -->
  <div id="page-tenants" class="hidden">
    <h1>ğŸ¢ Tenants <button class="btn btn-outline btn-sm" onclick="showPage('ollama')" style="margin-left:8px">ğŸ§  Models</button> <button class="btn btn-primary" onclick="showCreateModal()" style="margin-left:auto">+ New Tenant</button></h1>
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="tenant-search" placeholder="Search tenants by name, slug..." oninput="filterTenants(this.value)">
      <span class="search-shortcut">âŒ˜K</span>
    </div>
    <div id="tenants-list"></div>
  </div>
  <!-- Tenant Detail -->
  <div id="page-tenant-detail" class="hidden">
    <h1 style="margin-bottom:4px"><a href="#" onclick="showPage('tenants')" style="color:var(--muted);text-decoration:none">ğŸ¢ Tenants</a> / <span id="detail-tenant-name">â€”</span></h1>
    <div style="display:flex;gap:8px;margin-bottom:20px">
      <button class="btn btn-primary btn-sm detail-tab active" onclick="showDetailTab('overview',this)">ğŸ“‹ Overview</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('settings',this)">âš™ï¸ Settings</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('agents',this)">ğŸ¤– Agents</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('channels',this)">ğŸ“± Channels</button>
      <button class="btn btn-outline btn-sm detail-tab" onclick="showDetailTab('model',this)">ğŸ§  Model</button>
    </div>
    <!-- Overview Tab -->
    <div id="detail-tab-overview">
      <div class="stats" id="detail-stats"></div>
      <div class="card" id="detail-info" style="margin-bottom:15px"></div>
    </div>
    <!-- Settings Tab -->
    <div id="detail-tab-settings" class="hidden">
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">âš™ï¸ AI Provider & Model</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Provider</label>
            <select id="cfg-provider" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
              <option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option><option>llamacpp</option>
            </select>
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Model</label>
            <input id="cfg-model" placeholder="gpt-4o-mini" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">API Key</label>
            <input id="cfg-api-key" type="password" placeholder="sk-..." style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
          <div>
            <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">API Base URL</label>
            <input id="cfg-api-url" placeholder="https://api.openai.com/v1" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px">
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">ğŸ­ Identity</h3>
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Bot Name</label>
        <input id="cfg-identity-name" placeholder="Sales AI" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;margin-bottom:10px">
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">Persona</label>
        <input id="cfg-identity-persona" placeholder="A helpful sales assistant" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:14px;margin-bottom:10px">
        <label style="font-size:12px;color:var(--muted);margin-bottom:4px;display:block">System Prompt</label>
        <textarea id="cfg-identity-prompt" placeholder="You are a helpful AI assistant..." style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;font-family:monospace;min-height:100px;resize:vertical"></textarea>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="saveTenantConfig()">ğŸ’¾ LÆ°u Settings</button>
        <span id="cfg-save-status" style="font-size:12px;color:var(--green);line-height:36px"></span>
      </div>
    </div>
    <!-- Agents Tab -->
    <div id="detail-tab-agents" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
        <p style="font-size:12px;color:var(--muted)">Quáº£n lÃ½ agents cho tenant nÃ y. Má»—i agent cÃ³ provider, model vÃ  system prompt riÃªng.</p>
        <button class="btn btn-primary btn-sm" onclick="showAddAgentForm()">+ ThÃªm Agent</button>
      </div>
      <div id="add-agent-form" class="card hidden" style="margin-bottom:15px">
        <h3 style="margin-bottom:8px">ğŸ¤– New Agent</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
          <div><label style="font-size:11px;color:var(--muted)">Name</label><input id="ag-name" placeholder="sales-bot" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Role</label><input id="ag-role" value="assistant" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Provider</label><select id="ag-provider" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"><option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option></select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">
          <div><label style="font-size:11px;color:var(--muted)">Model</label><input id="ag-model" placeholder="gpt-4o-mini" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
          <div><label style="font-size:11px;color:var(--muted)">Description</label><input id="ag-desc" placeholder="Sales assistant" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:13px"></div>
        </div>
        <div style="margin-top:8px"><label style="font-size:11px;color:var(--muted)">System Prompt</label><textarea id="ag-prompt" placeholder="You are..." style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:12px;font-family:monospace;min-height:60px"></textarea></div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="btn btn-primary btn-sm" onclick="createTenantAgent()">ğŸ’¾ Táº¡o</button>
          <button class="btn btn-outline btn-sm" onclick="document.getElementById('add-agent-form').classList.add('hidden')">Huá»·</button>
        </div>
      </div>
      <div id="agents-list"></div>
    </div>
    <!-- Channels Tab -->
    <div id="detail-tab-channels" class="hidden">
      <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Cáº¥u hÃ¬nh kÃªnh giao tiáº¿p cho Agent. Báº­t/táº¯t vÃ  nháº­p thÃ´ng tin xÃ¡c thá»±c cho tá»«ng kÃªnh.</p>
      <div class="ch-grid" id="detail-ch-grid"></div>
    </div>
    <!-- Model Tab -->
    <div id="detail-tab-model" class="hidden">
      <div class="card" style="margin-bottom:15px">
        <h3 style="margin-bottom:12px">ğŸ§  Model Configuration</h3>
        <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Ollama models are shared across all tenants. Each tenant selects which model to use.<br>If Ollama is not installed on the server, use cloud providers (OpenAI, Anthropic, etc.) instead.</p>
        <div id="detail-model-info"></div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:12px">ğŸ“¦ Available Models (Shared Ollama)</h3>
        <div id="detail-models-list"></div>
        <div style="margin-top:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--border)">
          <p style="font-size:12px;color:var(--muted)">ğŸ’¡ Má»—i tenant dÃ¹ng chung Ollama server â€” chá»‰ cáº§n pull model 1 láº§n, táº¥t cáº£ tenant Ä‘á»u dÃ¹ng Ä‘Æ°á»£c. RAM Ä‘á»§ náº¿u chá»‰ run 1 model cÃ¹ng lÃºc (~2-4GB cho 7B model).</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Users -->
  <div id="page-users" class="hidden">
    <h1>ğŸ‘¥ Users <button class="btn btn-primary" onclick="showCreateUserModal()" style="margin-left:auto">+ Add User</button></h1>
    <div id="users-list"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div>
  </div>
  <!-- Audit -->
  <div id="page-audit" class="hidden">
    <h1>ğŸ“‹ Audit Log</h1>
    <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
      <select id="audit-filter-type" onchange="filterAuditEvents()" style="padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px">
        <option value="">All Events</option>
        <option value="login_success">Login</option>
        <option value="tenant_created">Tenant Created</option>
        <option value="tenant_started">Tenant Started</option>
        <option value="tenant_stopped">Tenant Stopped</option>
        <option value="tenant_deleted">Tenant Deleted</option>
        <option value="channel_configured">Channel Config</option>
        <option value="config_updated">Config Updated</option>
        <option value="agent_upserted">Agent Upserted</option>
        <option value="agent_deleted">Agent Deleted</option>
        <option value="user_created">User Created</option>
        <option value="user_deleted">User Deleted</option>
      </select>
      <input type="date" id="audit-filter-date" onchange="filterAuditEvents()" style="padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;color-scheme:dark">
      <button class="btn btn-outline btn-sm" onclick="clearAuditFilters()" style="align-self:center">âœ• Clear</button>
      <span id="audit-count" style="align-self:center;font-size:12px;color:var(--muted);margin-left:auto"></span>
    </div>
    <div id="audit-full"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div>
  </div>
  <!-- Ollama / Brain Engine -->
  <div id="page-ollama" class="hidden">
    <h1>ğŸ§  Brain / Ollama Management</h1>
    <div class="stats" style="margin-bottom:20px">
      <div class="stat" id="ollama-health-card"><label>Ollama Status</label><div class="val" id="ollama-status" style="font-size:16px">Checking...</div></div>
      <div class="stat"><label>Total Models</label><div class="val green" id="ollama-count">0</div></div>
      <div class="stat"><label>Ollama URL</label><div class="val" id="ollama-url" style="font-size:14px">â€”</div></div>
    </div>
    <div class="card" style="margin-bottom:15px">
      <h3 style="margin-bottom:12px">ğŸ“¥ Pull Model <span style="font-size:12px;color:var(--muted);font-weight:400">â€” Download from ollama.com</span></h3>
      <div style="display:flex;gap:8px">
        <select id="pull-model-name" style="flex:1;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
          <option value="tinyllama">tinyllama (637 MB)</option>
          <option value="phi3:mini">phi3:mini (2.3 GB)</option>
          <option value="llama3.2:1b">llama3.2:1b (1.3 GB)</option>
          <option value="llama3.2:3b">llama3.2:3b (2.0 GB)</option>
          <option value="qwen2.5:0.5b">qwen2.5:0.5b (397 MB)</option>
          <option value="qwen2.5:1.5b">qwen2.5:1.5b (986 MB)</option>
          <option value="gemma2:2b">gemma2:2b (1.6 GB)</option>
          <option value="deepseek-r1:1.5b">deepseek-r1:1.5b (1.1 GB)</option>
        </select>
        <input id="pull-model-custom" placeholder="Or type custom: mistral:7b" style="flex:1;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
        <button class="btn btn-primary" onclick="pullModel()" id="pull-btn">ğŸ“¥ Pull</button>
      </div>
      <div id="pull-status" style="margin-top:8px;font-size:12px;color:var(--muted);display:none"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:12px">ğŸ“¦ Installed Models</h3>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Model</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Size</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Family</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Params</th>
          <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Quant</th>
          <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">Actions</th>
        </tr></thead>
        <tbody id="ollama-models"></tbody>
      </table>
      <div id="ollama-empty" style="text-align:center;padding:24px;color:var(--muted);display:none">
        <p>ğŸ“¥ No models installed yet. Pull one above to get started!</p>
      </div>
    </div>
  </div>

  <!-- Agent Teams / Workflows -->
  <div id="page-teams" class="hidden">
    <h1>ğŸœ Agent Teams <button class="btn btn-primary" onclick="showCreateTeamModal()" style="margin-left:auto">+ Build Team</button></h1>

    <!-- Stats -->
    <div class="stats" id="teams-stats">
      <div class="stat"><label>Templates</label><div class="val" id="ts-templates">6</div></div>
      <div class="stat"><label>Active Teams</label><div class="val green" id="ts-active">0</div></div>
      <div class="stat"><label>Total Runs</label><div class="val" id="ts-runs">0</div></div>
      <div class="stat"><label>Success Rate</label><div class="val" id="ts-rate">â€”</div></div>
    </div>

    <!-- Template Gallery -->
    <div class="card" style="margin-bottom:20px">
      <h3>ğŸ“¦ Team Templates <a href="#" onclick="return false">Install with one click â†’</a></h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Pre-built agent teams â€” má»—i team gá»“m cÃ¡c agents chuyÃªn biá»‡t phá»‘i há»£p hoÃ n thÃ nh workflow.</p>
      <div class="teams-templates" id="tpl-gallery"></div>
    </div>

    <!-- Active Teams -->
    <div class="card" style="margin-bottom:20px">
      <h3>âš¡ Active Teams <a href="#" onclick="return false" id="teams-refresh">Refresh â†»</a></h3>
      <div id="active-teams-list"></div>
    </div>

    <!-- Recent Workflow Runs -->
    <div class="card">
      <h3>ğŸ“Š Recent Workflow Runs <a href="#" onclick="return false">View all â†’</a></h3>
      <div class="team-runs" id="workflow-runs"></div>
    </div>
  </div>

</main>

<!-- Team Template Detail Modal -->
<div id="modal-team-detail" class="modal-overlay hidden">
  <div class="modal" style="min-width:650px;max-width:800px">
    <h2 id="tpl-detail-title">Team Template</h2>
    <p id="tpl-detail-desc" style="font-size:13px;color:var(--muted);margin-bottom:16px"></p>
    
    <!-- Pipeline visualization -->
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;display:block;margin-bottom:8px">Pipeline</label>
      <div id="tpl-detail-pipeline" style="display:flex;align-items:center;gap:0;flex-wrap:wrap;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--border)"></div>
    </div>
    
    <!-- Agents -->
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;display:block;margin-bottom:8px">Agent Roles</label>
      <div class="team-agents-grid" id="tpl-detail-agents"></div>
    </div>

    <!-- Config -->
    <div style="margin-bottom:16px">
      <label style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;display:block;margin-bottom:8px">Configuration</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label style="font-size:11px;color:var(--muted)">Max retries per step</label>
          <input id="tpl-cfg-retries" type="number" value="2" min="0" max="5" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
        </div>
        <div>
          <label style="font-size:11px;color:var(--muted)">Timeout per agent (seconds)</label>
          <input id="tpl-cfg-timeout" type="number" value="900" min="60" max="3600" style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-team-detail')">ÄÃ³ng</button>
      <button class="btn btn-green" onclick="installTeamTemplate()" id="btn-install-tpl">ğŸš€ CÃ i Ä‘áº·t Team</button>
    </div>
  </div>
</div>

<!-- Run Workflow Modal -->
<div id="modal-run-workflow" class="modal-overlay hidden">
  <div class="modal" style="min-width:500px">
    <h2>â–¶ï¸ Cháº¡y Workflow</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:12px">Team: <strong id="run-team-name" style="color:var(--accent)"></strong></p>
    <label>MÃ´ táº£ task</label>
    <textarea id="run-task-input" placeholder="VÃ­ dá»¥: ThÃªm chá»©c nÄƒng xÃ¡c thá»±c OAuth2.0 cho há»‡ thá»‘ng..." style="min-height:100px"></textarea>
    <label>Tenant Ä‘á»ƒ cháº¡y</label>
    <select id="run-tenant-select" style="width:100%;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px">
      <option value="">-- Chá»n tenant --</option>
    </select>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-run-workflow')">Huá»·</button>
      <button class="btn btn-primary" onclick="startWorkflowRun()">ğŸš€ Báº¯t Ä‘áº§u</button>
    </div>
  </div>
</div>

<!-- Create Custom Team Modal -->
<div id="modal-create-team" class="modal-overlay hidden">
  <div class="modal" style="min-width:600px">
    <h2>ğŸ—ï¸ Build Custom Team</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Táº¡o team agent tÃ¹y chá»‰nh vá»›i pipeline riÃªng. Má»—i agent cÃ³ persona vÃ  vai trÃ² riÃªng biá»‡t.</p>
    
    <label>Team Name</label>
    <input id="ct-name" placeholder="my-data-pipeline">
    <label>Description</label>
    <input id="ct-desc" placeholder="Pipeline xá»­ lÃ½ vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u khÃ¡ch hÃ ng">
    
    <div style="margin-top:16px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
      <label style="margin:0">Agents</label>
      <button class="btn btn-outline btn-sm" onclick="addCustomAgent()">+ Add Agent</button>
    </div>
    <div id="ct-agents-list"></div>
    
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-create-team')">Huá»·</button>
      <button class="btn btn-primary" onclick="createCustomTeam()">ğŸ’¾ Táº¡o Team</button>
    </div>
  </div>
</div>

<!-- Create Tenant Modal -->
<div id="modal-create" class="modal-overlay hidden">
  <div class="modal">
    <h2>Create Tenant</h2>
    <label>Name</label><input id="f-name" placeholder="My Bot">
    <label>Slug (subdomain)</label><input id="f-slug" placeholder="mybot">
    <label>Provider</label>
    <select id="f-provider"><option>openai</option><option>anthropic</option><option>ollama</option><option>gemini</option><option>deepseek</option><option>groq</option><option>brain</option></select>
    <label>Model</label><input id="f-model" value="gpt-4o-mini">
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-create')">Cancel</button>
      <button id="btn-create-tenant" class="btn btn-primary" onclick="createTenant()">Create</button>
    </div>
  </div>
</div>

<!-- Channel Configuration Modal -->
<div id="modal-channels" class="modal-overlay hidden">
  <div class="modal" style="min-width:680px">
    <h2>âš™ï¸ Channel Configuration â€” <span id="ch-tenant-name"></span></h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:15px">Cáº¥u hÃ¬nh kÃªnh giao tiáº¿p cho Agent. Báº­t/táº¯t vÃ  nháº­p thÃ´ng tin xÃ¡c thá»±c cho tá»«ng kÃªnh.</p>
    <div class="ch-grid" id="ch-grid"></div>
    <div class="actions" style="margin-top:20px">
      <button class="btn btn-outline" onclick="hideModal('modal-channels')">ÄÃ³ng</button>
    </div>
  </div>
</div>

<!-- Zalo QR Modal -->
<div id="modal-zalo-qr" class="modal-overlay hidden">
  <div class="modal" style="text-align:center;min-width:350px">
    <h2>ğŸ“± QuÃ©t QR Zalo</h2>
    <div id="qr-display" class="qr-container">
      <p style="color:var(--muted)">Äang táº£i mÃ£ QR...</p>
    </div>
    <div style="margin-top:12px;text-align:left">
      <label style="font-size:12px;color:var(--muted)">Hoáº·c paste cookie Zalo Web:</label>
      <textarea id="zalo-cookie-input" placeholder="Paste cookie tá»« DevTools (F12 â†’ Application â†’ Cookies â†’ chat.zalo.me)" style="font-family:monospace;font-size:11px;min-height:60px;margin-top:4px"></textarea>
    </div>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-zalo-qr')">Huá»·</button>
      <button class="btn btn-green" onclick="saveZaloCookie()">ğŸ’¾ LÆ°u Cookie</button>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div id="modal-create-user" class="modal-overlay hidden">
  <div class="modal">
    <h2>ğŸ‘¤ Add User</h2>
    <label>Email</label><input id="fu-email" type="text" inputmode="email" autocomplete="email" placeholder="user@example.com">
    <label>Password</label><input id="fu-password" type="password" placeholder="Minimum 8 characters">
    <label>Role</label>
    <select id="fu-role">
      <option value="admin">ğŸŸ¡ Admin</option>
      <option value="viewer">ğŸŸ¢ Viewer</option>
      <option value="superadmin">ğŸ”´ Super Admin</option>
    </select>
    <label>Assign to Tenant (Optional)</label>
    <select id="fu-tenant">
      <option value="">-- No Tenant (All Access for Admins) --</option>
    </select>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-create-user')">Cancel</button>
      <button class="btn btn-primary" onclick="createUser()">Create</button>
    </div>
  </div>
</div>

<!-- Assign Tenant Modal -->
<div id="modal-assign-tenant" class="modal-overlay hidden">
  <div class="modal">
    <h2>ğŸ¢ Assign Tenant</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:10px">User: <strong id="at-email" style="color:var(--accent)"></strong></p>
    <input type="hidden" id="at-id">
    <label>Select Tenant</label>
    <select id="at-tenant">
      <option value="">-- No Tenant (Remove Access) --</option>
    </select>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-assign-tenant')">Cancel</button>
      <button class="btn btn-primary" onclick="assignUserTenant()">Save</button>
    </div>
  </div>
</div>

<!-- Reset User Password Modal (Admin) -->
<div id="modal-reset-password" class="modal-overlay hidden">
  <div class="modal">
    <h2>ğŸ”‘ Reset User Password</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:10px">User: <strong id="rp-email" style="color:var(--accent)"></strong></p>
    <input type="hidden" id="rp-id">
    <label>New Password</label><input id="rp-new-password" type="password" placeholder="Máº­t kháº©u má»›i (Ã­t nháº¥t 6 kÃ½ tá»±)">
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-reset-password')">Cancel</button>
      <button class="btn btn-primary" onclick="adminResetUserPassword()">Reset Password</button>
    </div>
  </div>
</div>

<!-- Change Role Modal -->
<div id="modal-change-role" class="modal-overlay hidden">
  <div class="modal">
    <h2>ğŸ”„ Äá»•i Role</h2>
    <p style="font-size:13px;color:var(--muted);margin-bottom:10px">User: <strong id="cr-email" style="color:var(--accent)"></strong></p>
    <input type="hidden" id="cr-id">
    <label>Role má»›i</label>
    <select id="cr-role">
      <option value="superadmin">ğŸ”´ Super Admin â€” Full quyá»n toÃ n bá»™ há»‡ thá»‘ng</option>
      <option value="admin" selected>ğŸŸ¡ Admin â€” Quáº£n lÃ½ tenant cá»§a mÃ¬nh</option>
      <option value="viewer">ğŸŸ¢ Viewer â€” Xem vÃ  cáº¥u hÃ¬nh tenant Ä‘Æ°á»£c gÃ¡n</option>
    </select>
    <div class="actions">
      <button class="btn btn-outline" onclick="hideModal('modal-change-role')">Cancel</button>
      <button class="btn btn-primary" onclick="changeUserRole()">Save Role</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
const API='/api/admin';
let currentPage='dashboard';
let channelTenantId=null;
let channelTenantName='';
let authToken=localStorage.getItem('bizclaw_admin_token')||'';
let allTenants=[]; // Cache for filtering

const PROVIDER_ICONS = {
  openai: 'ğŸŸ¢', anthropic: 'ğŸŸ¤', ollama: 'ğŸ”µ', gemini: 'ğŸŸ£',
  deepseek: 'ğŸ”·', groq: 'ğŸŸ ', brain: 'ğŸ”´', llamacpp: 'ğŸŸ¡'
};
function providerBadge(p,m){
  const icon = PROVIDER_ICONS[p]||'âšª';
  return `<span class="provider-icon ${p||''}">${icon} ${p||'â€”'}/${m||'â€”'}</span>`;
}
function escapeHtml(s){
  if(!s)return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â”€â”€ Auth helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function authHeaders(extra={}){
  return {...extra,'Authorization':'Bearer '+authToken,'Content-Type':'application/json'};
}
async function authFetch(url,opts={}){
  opts.headers=authHeaders(opts.headers||{});
  const res=await fetch(url,opts);
  if(res.status===401){localStorage.removeItem('bizclaw_admin_token');authToken='';showLogin();throw new Error('Session expired');}
  return res;
}
function showLogin(){
  document.getElementById('login-screen').style.display='flex';
}
function hideLogin(){document.getElementById('login-screen').style.display='none';}
function showAuthBox(boxId) {
  ['login-form-box', 'register-form-box', 'forgot-form-box', 'reset-form-box'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById(boxId).style.display = 'block';
}

async function doLogin(){
  const email=document.getElementById('login-email').value;
  const password=document.getElementById('login-password').value;
  const errEl=document.getElementById('login-error');
  errEl.style.display='none';
  try{
    const res=await fetch(API+'/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const r=await res.json();
    if(r.ok){authToken=r.token;localStorage.setItem('bizclaw_admin_token',authToken);localStorage.setItem('bizclaw_setup_done','1');hideLogin();initRouter();toast('\u2705 Login successful');}
    else{errEl.textContent=r.error||'Login failed';errEl.style.display='block';}
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
}

async function doRegister(){
  const errEl=document.getElementById('register-error');
  errEl.style.display='none';
  const company_name=document.getElementById('register-company').value;
  const email=document.getElementById('register-email').value;
  const password=document.getElementById('register-password').value;
  
  if(!company_name || !email || !password){ errEl.textContent='Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin';errEl.style.display='block';return; }
  
  errEl.style.color='var(--accent)';errEl.textContent='Äang khá»Ÿi táº¡o há»‡ thá»‘ng (vui lÃ²ng chá»)...';errEl.style.display='block';
  try {
    const res=await fetch(API+'/register', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({company_name, email, password})
    });
    const r=await res.json();
    if(r.ok) {
         errEl.style.color='var(--green)';
         errEl.textContent=r.message || 'ÄÄƒng kÃ½ thÃ nh cÃ´ng! TÃ i khoáº£n Ä‘ang chá» Admin duyá»‡t.';
    } else {
         errEl.style.color='var(--red)';
         errEl.textContent=r.error;
    }
  } catch(e){ errEl.style.color='var(--red)'; errEl.textContent=e.message; }
}

async function doForgotPassword(){
  const errEl=document.getElementById('forgot-error');
  const email=document.getElementById('forgot-email').value;
  if(!email){ errEl.textContent='Nháº­p email'; errEl.style.display='block'; return; }
  
  try {
    const res=await fetch(API+'/password-reset', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email})
    });
    const r=await res.json();
    if(r.ok){ errEl.style.color='var(--green)'; errEl.textContent='LiÃªn káº¿t khÃ´i phá»¥c Ä‘Ã£ Ä‘Æ°á»£c gá»­i vÃ o email (náº¿u cÃ³ tá»“n táº¡i).'; errEl.style.display='block'; }
    else{ errEl.style.color='var(--red)'; errEl.textContent=r.error; errEl.style.display='block'; }
  } catch(e) { errEl.textContent=e.message; errEl.style.display='block'; }
}

async function doResetPassword() {
  const errEl=document.getElementById('reset-error');
  const new_password=document.getElementById('reset-password-input').value;
  const urlParams = new URL(window.location.href).searchParams;
  let token = urlParams.get('token');
  if(!token) {
      // It might be in the hash: #/reset-password?token=XYZ
      const hash = window.location.hash;
      if(hash.includes('?token=')) token = hash.split('?token=')[1];
  }
  
  if(!token || !new_password){ errEl.textContent='Thiáº¿u token hoáº·c máº­t kháº©u'; errEl.style.display='block'; return;}
  
  try {
    const res=await fetch(API+'/password-reset/confirm', {
      method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({token, new_password})
    });
    const r=await res.json();
    if(r.ok){ 
      errEl.style.color='var(--green)'; errEl.textContent='Äá»•i máº­t kháº©u thÃ nh cÃ´ng! Chuyá»ƒn hÆ°á»›ng...'; errEl.style.display='block';
      setTimeout(()=>{ window.location.hash=''; showAuthBox('login-form-box'); }, 2000);
    }
    else { errEl.style.color='var(--red)'; errEl.textContent=r.error; errEl.style.display='block'; }
  } catch(e) { errEl.textContent=e.message; errEl.style.display='block'; }
}

async function doChangePassword() {
  const current_password=document.getElementById('profile-current-pwd').value;
  const new_password=document.getElementById('profile-new-pwd').value;
  const msg=document.getElementById('profile-msg');
  if(!current_password || !new_password) { msg.textContent='Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin'; msg.style.background='rgba(255,0,0,0.1)'; msg.style.color='var(--red)'; msg.style.display='block'; return; }
  
  msg.textContent='Äang xá»­ lÃ½...'; msg.style.color='var(--text2)'; msg.style.background='var(--bg2)'; msg.style.display='block';
  
  try {
    const res=await req('/users/me/password', 'PUT', {current_password, new_password});
    if(res.ok) {
       msg.textContent='Äá»•i máº­t kháº©u thÃ nh cÃ´ng!'; msg.style.color='var(--green)'; msg.style.background='rgba(0,255,0,0.1)';
       document.getElementById('profile-current-pwd').value='';
       document.getElementById('profile-new-pwd').value='';
    } else {
       msg.textContent=res.error; msg.style.color='var(--red)'; msg.style.background='rgba(255,0,0,0.1)';
    }
  } catch(e) { msg.textContent=e.message; msg.style.color='var(--red)'; msg.style.background='rgba(255,0,0,0.1)'; }
}
function checkAuth(){
  const hash = window.location.hash;
  if(hash.includes('reset-password?token=')) {
    showLogin();
    showAuthBox('reset-form-box');
    return;
  }
  if(!authToken){showLogin();}else{hideLogin();initRouter();}
}

// â”€â”€ Navigation (Hash-based routing â€” F5 safe) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses hash (#/tenants) instead of pathname (/tenants) so Nginx
// always serves the admin page and routing is purely client-side.

const ROUTE_MAP = {
  '': 'dashboard',
  '/': 'dashboard',
  '/dashboard': 'dashboard',
  '/tenants': 'tenants',
  '/users': 'users',
  '/teams': 'teams',
  '/audit': 'audit',
  '/ollama': 'ollama',
  '/profile': 'profile',
};

function showPage(p, updateHash = true){
  document.querySelectorAll('.main>div').forEach(d=>d.classList.add('hidden'));
  const page = document.getElementById('page-'+p);
  if(page) {
    page.classList.remove('hidden');
    page.classList.add('page-enter');
    setTimeout(()=>page.classList.remove('page-enter'), 300);
  }

  // Update sidebar active state
  document.querySelectorAll('.sidebar a[data-page]').forEach(a=>{
    a.classList.toggle('active', a.dataset.page === p || (p === 'tenant-detail' && a.dataset.page === 'tenants'));
  });

  // Update hash in URL (e.g. #/tenants)
  if(updateHash){
    const hash = '#/' + (p === 'dashboard' ? 'dashboard' : p);
    if(window.location.hash !== hash){
      window.location.hash = hash;
    }
  }

  currentPage=p;loadPage();
}

// Handle browser back/forward + hash changes
window.addEventListener('hashchange', () => {
  const p = routeFromHash();
  showPage(p, false);
});

// Read route from current URL hash
function routeFromHash(){
  const hash = window.location.hash.replace(/^#/, '') || '/';
  // Check for /tenants/{id} pattern
  const tenantMatch = hash.match(/^\/tenants\/(.+)/);
  if(tenantMatch) return 'tenant-detail';
  return ROUTE_MAP[hash] || 'dashboard';
}

// Initialize routing â€” sidebar link interception + hash-based page load
function initRouter(){
  // Intercept sidebar link clicks
  document.querySelectorAll('.sidebar a[data-page]').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      showPage(a.dataset.page);
    });
  });

  // Load the page based on current hash
  const page = routeFromHash();
  showPage(page, false);
}

function loadPage(){
  if(currentPage==='dashboard')loadDashboard();
  else if(currentPage==='tenants')loadTenants();
  else if(currentPage==='tenant-detail') loadTenantDetailFromHash();
  else if(currentPage==='users')loadUsers();
  else if(currentPage==='teams')loadTeams();
  else if(currentPage==='audit')loadAudit();
  else if(currentPage==='ollama')loadOllama();
}

// Load tenant detail from URL hash (e.g. after F5 or direct navigation)
async function loadTenantDetailFromHash() {
  const hash = window.location.hash.replace(/^#/, '') || '/';
  const m = hash.match(/^\/tenants\/(.+)/);
  if(!m) { showPage('tenants'); return; }
  const tenantId = m[1];
  // If already loaded this tenant, skip
  if(detailTenantId === tenantId && document.getElementById('detail-tenant-name').textContent !== 'â€”') return;
  try {
    const res = await authFetch(API+'/tenants/'+tenantId);
    const data = await res.json();
    if(data.ok && data.tenant) {
      const t = data.tenant;
      openTenantDetail(t.id, t.name, t.slug, t.provider, t.model, t.status, t.plan, t.pairing_code||'', t.port||'');
    } else {
      toast('âŒ Tenant not found', 'error');
      showPage('tenants');
    }
  } catch(e) {
    toast('âŒ '+e.message, 'error');
    showPage('tenants');
  }
}

// â”€â”€ Toast (stacking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg,type='success'){
  const t=document.createElement('div');t.className='toast'+(type==='error'?' error':'');
  t.textContent=msg;
  const container=document.getElementById('toast-container');
  container.appendChild(t);
  // Limit to 5 visible toasts
  while(container.children.length>5) container.firstChild.remove();
  setTimeout(()=>{if(t.parentNode) t.remove();},3200);
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard(){
  try {
    const s=await(await authFetch(API+'/stats')).json();
    document.getElementById('stats-row').innerHTML=
      `<div class="stat"><label>Total Tenants</label><div class="val">${s.total_tenants}</div></div>`+
      `<div class="stat"><label>Running</label><div class="val green">${s.running}</div></div>`+
      `<div class="stat"><label>Stopped</label><div class="val">${s.stopped}</div></div>`+
      `<div class="stat"><label>Error</label><div class="val red">${s.error}</div></div>`+
      `<div class="stat"><label>Users</label><div class="val">${s.users}</div></div>`;
  } catch(e) {
    document.getElementById('stats-row').innerHTML='<div class="stat" style="grid-column:1/-1;text-align:center;color:var(--red)">âŒ Failed to load stats</div>';
  }
  try {
    const t=await(await authFetch(API+'/tenants')).json();
    document.getElementById('health-list').innerHTML=t.tenants.slice(0,5).map(t=>
      `<div class="tenant-row"><div><span class="tenant-name">${escapeHtml(t.name)}</span><div class="tenant-slug">${escapeHtml(t.slug)} Â· ${providerBadge(t.provider,t.model)}</div></div><span class="badge ${t.status}">${t.status}</span></div>`).join('')||'<p style="color:var(--muted);font-size:13px;padding:12px 0">No tenants yet</p>';
  } catch(e) {
    document.getElementById('health-list').innerHTML='<p style="color:var(--red);font-size:13px">Failed to load tenants</p>';
  }
  try {
    const a=await(await authFetch(API+'/activity')).json();
    document.getElementById('activity-list').innerHTML=(a.events||[]).slice(0,8).map(e=>
      `<div class="event"><div><div class="type">${escapeHtml(e.event_type)}</div><div class="meta">${escapeHtml(e.actor_type)} (${(e.actor_id||'').slice(0,8)}â€¦)</div></div><div class="time">${timeAgo(e.created_at)}</div></div>`).join('')||'<p style="color:var(--muted);font-size:13px;padding:12px 0">No recent activity</p>';
  } catch(e) {
    document.getElementById('activity-list').innerHTML='<p style="color:var(--red);font-size:13px">Failed to load activity</p>';
  }
}
function timeAgo(ts){
  if(!ts) return 'â€”';
  try {
    const d=new Date(ts);
    const now=new Date();
    const diff=Math.floor((now-d)/1000);
    if(diff<60) return 'just now';
    if(diff<3600) return Math.floor(diff/60)+'m ago';
    if(diff<86400) return Math.floor(diff/3600)+'h ago';
    return Math.floor(diff/86400)+'d ago';
  } catch { return ts; }
}

// â”€â”€ Tenants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTenants(){
  const d=await(await authFetch(API+'/tenants')).json();
  allTenants = d.tenants || [];
  renderTenantList(allTenants);
}
function filterTenants(query){
  const q=query.toLowerCase().trim();
  if(!q) { renderTenantList(allTenants); return; }
  renderTenantList(allTenants.filter(t=>
    (t.name||'').toLowerCase().includes(q)||
    (t.slug||'').toLowerCase().includes(q)||
    (t.provider||'').toLowerCase().includes(q)||
    (t.status||'').toLowerCase().includes(q)
  ));
}
function renderTenantList(tenants){
  const baseDomain=location.hostname.replace(/^(admin|apps)\./,'');
  const proto=location.protocol;
  if(!tenants.length){
    document.getElementById('tenants-list').innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)"><p style="font-size:16px;margin-bottom:8px">ğŸ” No tenants found</p><p style="font-size:13px">Try adjusting your search or create a new tenant.</p></div>';
    return;
  }
  document.getElementById('tenants-list').innerHTML=tenants.map(t=>{
    return `<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${escapeHtml(t.name)}</strong> <span class="badge ${t.status}">${t.status}</span>
          <div class="tenant-slug" style="margin-top:4px">
            <a href="${proto}//${escapeHtml(t.slug)}.${baseDomain}" target="_blank" style="color:var(--accent);text-decoration:none;font-weight:500">ğŸ”— ${escapeHtml(t.slug)}.${baseDomain}</a>
            Â· ${providerBadge(t.provider,t.model)} Â· <span style="color:var(--muted);font-size:11px">${escapeHtml(t.plan)}</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-primary btn-sm" onclick="openTenantDetail('${t.id}','${esc(t.name)}','${esc(t.slug)}','${esc(t.provider)}','${esc(t.model)}','${t.status}','${esc(t.plan)}','${esc(t.pairing_code||'')}','${t.port||''}')" title="Tenant Detail">âš™ï¸ Detail</button>
          ${t.status!=='running'
            ?`<button class="btn btn-primary btn-sm" onclick="tenantAction('${t.id}','start')">â–¶ Start</button>`
            :`<button class="btn btn-outline btn-sm" onclick="tenantAction('${t.id}','stop')">â¹ Stop</button>`}
          <button class="btn btn-outline btn-sm" onclick="tenantAction('${t.id}','restart')" title="Restart">ğŸ”„</button>
          <button class="btn btn-danger btn-sm" onclick="tenantAction('${t.id}','delete')" title="Delete">âœ•</button>
        </div>
      </div>
      ${t.pairing_code?`<div style="margin-top:10px;font-size:12px;color:var(--muted)">Pairing: <strong style="color:var(--yellow);font-size:16px;font-family:monospace;letter-spacing:2px">${t.pairing_code}</strong></div>`:''}
    </div>`;
  }).join('');
}
function esc(s){return (s||"").replace(/'/g,"\\'");}


// â”€â”€ Users & Audit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Users (full CRUD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers(){
  try {
    const d=await(await authFetch(API+'/users')).json();
    const users = d.users || [];
    if(!users.length) {
      document.getElementById('users-list').innerHTML=`
        <div style="text-align:center;padding:40px;color:var(--muted)">
          <p style="font-size:40px;margin-bottom:12px">ğŸ‘¤</p>
          <p style="font-size:16px;margin-bottom:8px">No users yet</p>
          <p style="font-size:13px;margin-bottom:16px">Create the first admin user to get started.</p>
          <button class="btn btn-primary" onclick="showCreateUserModal()">+ Add First User</button>
        </div>`;
      return;
    }
    
    // Attempt to match tenant IDs with names if we have loaded tenants
    const tenantMap = {};
    if (allTenants && allTenants.length) {
      allTenants.forEach(t => { tenantMap[t.id] = t.name; });
    }

    // Check if current user is super admin
    const isSuperAdmin = isCurrentUserSuperAdmin();

    document.getElementById('users-list').innerHTML=users.map(u => {
      const statusCls = u.status==='active' ? 'running' : u.status==='pending' ? 'stopped' : 'error';
      const statusLabel = u.status || 'active';
      return `
      <div class="card" style="margin-bottom:10px;${u.status==='pending'?'border-left:3px solid var(--yellow)':u.status==='suspended'?'border-left:3px solid var(--red)':''}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong style="color:var(--accent)">${escapeHtml(u.email)}</strong>
            <span class="badge ${u.role==='admin'?'running':'stopped'}" style="margin-left:8px">${escapeHtml(u.role)}</span>
            <span class="badge ${statusCls}" style="margin-left:4px">${statusLabel}</span>
            ${u.tenant_id ? `<span class="badge" style="margin-left:8px;background:var(--subtle);color:var(--text)">Tenant: ${escapeHtml(tenantMap[u.tenant_id] || u.tenant_id.slice(0,8))}</span>` : ''}
            <div style="font-size:11px;color:var(--muted);margin-top:4px">
              Created: ${timeAgo(u.created_at)} Â· ID: <code style="font-size:10px">${(u.id||'').slice(0,8)}â€¦</code>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            ${isSuperAdmin && u.status==='pending' ? `<button class="btn btn-primary btn-sm" onclick="updateUserStatus('${esc(u.id)}','active')">âœ… Approve</button>` : ''}
            ${isSuperAdmin && u.status==='active' && u.email!=='admin@bizclaw.vn' ? `<button class="btn btn-outline btn-sm" onclick="updateUserStatus('${esc(u.id)}','suspended')">â¸ Suspend</button>` : ''}
            ${isSuperAdmin && u.status==='suspended' ? `<button class="btn btn-primary btn-sm" onclick="updateUserStatus('${esc(u.id)}','active')">âœ… Reactivate</button>` : ''}
            <button class="btn btn-outline btn-sm" onclick="showResetPasswordModal('${esc(u.id)}','${esc(u.email)}')">ğŸ”‘ Reset Pass</button>
            ${isSuperAdmin ? `<button class="btn btn-outline btn-sm" onclick="showAssignTenantModal('${esc(u.id)}','${esc(u.email)}')">ğŸ¢ Assign Tenant</button>` : ''}
            ${isSuperAdmin && u.email!=='admin@bizclaw.vn' ? `<button class="btn btn-outline btn-sm" onclick="showChangeRoleModal('${esc(u.id)}','${esc(u.email)}','${esc(u.role)}')">ğŸ”„ Role</button>` : ''}
            ${isSuperAdmin && u.email!=='admin@bizclaw.vn' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${esc(u.id)}','${esc(u.email)}')" title="Delete User">âœ•</button>` : ''}
          </div>
        </div>
      </div>
    `;}).join('');
  } catch(e) {
    document.getElementById('users-list').innerHTML='<p style="color:var(--red);font-size:13px">âŒ Failed to load users</p>';
  }
}

function isCurrentUserSuperAdmin() {
  try {
    if(!authToken) return false;
    const payload = JSON.parse(atob(authToken.split('.')[1]));
    return payload.email === 'admin@bizclaw.vn' || payload.role === 'superadmin';
  } catch { return false; }
}

async function updateUserStatus(id, status) {
  const labels = {active: 'kÃ­ch hoáº¡t', suspended: 'táº¡m khÃ³a'};
  if(!confirm(`Báº¡n muá»‘n ${labels[status]||status} user nÃ y?`)) return;
  try {
    const r = await(await authFetch(API+'/users/'+id+'/status',{method:'PUT',body:JSON.stringify({status})})).json();
    if(r.ok) { toast(`âœ… User status â†’ ${status}`); loadUsers(); }
    else { toast('âŒ '+r.error,'error'); }
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

async function fetchTenantsForSelect(selectId) {
  try {
    const res = await authFetch(API+'/tenants');
    const d = await res.json();
    const tenants = d.tenants || [];
    const select = document.getElementById(selectId);
    select.innerHTML = '<option value="">-- No Tenant (Remove Access/All Access) --</option>' + 
      tenants.map(t => `<option value="${t.id}">${escapeHtml(t.name)} (${t.slug})</option>`).join('');
  } catch(e) {
    console.error("Failed to load tenants for select", e);
  }
}

function showCreateUserModal(){ 
  fetchTenantsForSelect('fu-tenant');
  document.getElementById('modal-create-user').classList.remove('hidden'); 
}

function showAssignTenantModal(id, email) {
  document.getElementById('at-id').value = id;
  document.getElementById('at-email').textContent = email;
  fetchTenantsForSelect('at-tenant');
  document.getElementById('modal-assign-tenant').classList.remove('hidden');
}

async function assignUserTenant() {
  const id = document.getElementById('at-id').value;
  const tenant_id = document.getElementById('at-tenant').value;
  try {
    const r = await(await authFetch(API+'/users/'+id+'/tenant',{method:'PUT',body:JSON.stringify({tenant_id})})).json();
    if(r.ok) { hideModal('modal-assign-tenant'); toast('âœ… Tenant assigned'); loadUsers(); }
    else { toast('âŒ '+r.error,'error'); }
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

function showResetPasswordModal(id, email) {
  document.getElementById('rp-id').value = id;
  document.getElementById('rp-email').textContent = email;
  document.getElementById('rp-new-password').value = '';
  document.getElementById('modal-reset-password').classList.remove('hidden');
}

async function adminResetUserPassword() {
  const id = document.getElementById('rp-id').value;
  const new_password = document.getElementById('rp-new-password').value;
  if(!new_password || new_password.length < 6) { toast('âŒ Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±','error'); return; }
  try {
    const r = await(await authFetch(API+'/users/'+id+'/password/reset',{method:'PUT',body:JSON.stringify({new_password})})).json();
    if(r.ok) { hideModal('modal-reset-password'); toast('âœ… Máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t láº¡i thÃ nh cÃ´ng'); }
    else { toast('âŒ '+r.error,'error'); }
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

function showChangeRoleModal(id, email, currentRole) {
  document.getElementById('cr-id').value = id;
  document.getElementById('cr-email').textContent = email;
  document.getElementById('cr-role').value = currentRole || 'admin';
  document.getElementById('modal-change-role').classList.remove('hidden');
}

async function changeUserRole() {
  const id = document.getElementById('cr-id').value;
  const role = document.getElementById('cr-role').value;
  const roleLabels = {superadmin: 'Super Admin', admin: 'Admin', viewer: 'Viewer'};
  if(!confirm(`Äá»•i role thÃ nh "${roleLabels[role] || role}"?`)) return;
  try {
    const r = await(await authFetch(API+'/users/'+id+'/role',{method:'PUT',body:JSON.stringify({role})})).json();
    if(r.ok) { hideModal('modal-change-role'); toast(`âœ… Role â†’ ${roleLabels[role] || role}`); loadUsers(); }
    else { toast('âŒ '+r.error,'error'); }
  } catch(e) { toast('âŒ '+e.message,'error'); }
}

async function createUser(){
  const email=document.getElementById('fu-email').value.trim();
  const password=document.getElementById('fu-password').value;
  const role=document.getElementById('fu-role').value;
  const tenant_id=document.getElementById('fu-tenant').value;
  if(!email||!password){toast('Email and password required','error');return;}
  if(password.length<8){toast('Password must be at least 8 characters','error');return;}
  try{
    const reqBody = { email, password, role };
    if (tenant_id) reqBody.tenant_id = tenant_id;
    const r=await(await authFetch(API+'/users',{method:'POST',body:JSON.stringify(reqBody)})).json();
    if(r.ok){hideModal('modal-create-user');toast('âœ… User created');document.getElementById('fu-email').value='';document.getElementById('fu-password').value='';loadUsers();}
    else{toast('âŒ '+r.error,'error');}
  }catch(e){toast('âŒ '+e.message,'error');}
}
async function deleteUser(id,email){
  if(!confirm(`XÃ³a user "${email}"? Táº¤T Cáº¢ tenant vÃ  dá»¯ liá»‡u cá»§a user nÃ y sáº½ bá»‹ xÃ³a vÄ©nh viá»…n!`))return;
  try{
    const r=await(await authFetch(API+'/users/'+id,{method:'DELETE'})).json();
    if(r.ok){toast(`âœ… User deleted (${r.tenants_deleted||0} tenants removed)`);loadUsers();}
    else{toast('âŒ '+r.error,'error');}
  }catch(e){toast('âŒ '+e.message,'error');}
}

// â”€â”€ Audit (with filters) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allAuditEvents = [];
async function loadAudit(){
  try {
    const d=await(await authFetch(API+'/activity')).json();
    allAuditEvents = d.events || [];
    filterAuditEvents();
  } catch(e) {
    document.getElementById('audit-full').innerHTML='<p style="color:var(--red);font-size:13px">âŒ Failed to load audit log</p>';
  }
}
function filterAuditEvents(){
  const typeFilter = document.getElementById('audit-filter-type')?.value || '';
  const dateFilter = document.getElementById('audit-filter-date')?.value || '';
  let filtered = allAuditEvents;
  if(typeFilter) filtered = filtered.filter(e => e.event_type === typeFilter);
  if(dateFilter) filtered = filtered.filter(e => (e.created_at||'').startsWith(dateFilter));
  const countEl = document.getElementById('audit-count');
  if(countEl) countEl.textContent = filtered.length + ' of ' + allAuditEvents.length + ' events';
  if(!filtered.length) {
    document.getElementById('audit-full').innerHTML=`
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <p style="font-size:40px;margin-bottom:12px">ğŸ“‹</p>
        <p style="font-size:16px;margin-bottom:8px">${allAuditEvents.length ? 'No matching events' : 'No audit events yet'}</p>
        <p style="font-size:13px">${allAuditEvents.length ? 'Try adjusting your filters.' : 'Events will appear as you use the platform.'}</p>
      </div>`;
    return;
  }
  document.getElementById('audit-full').innerHTML=filtered.map(e => {
    const tb = eventTypeBadge(e.event_type);
    return `<div class="event" style="padding:10px 0">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${tb.icon}</span>
        <div>
          <div class="type" style="display:flex;align-items:center;gap:6px">
            ${escapeHtml(e.event_type)}
            <span class="badge ${tb.cls}" style="font-size:9px">${tb.label}</span>
          </div>
          <div class="meta">${escapeHtml(e.actor_type)} Â· <code style="font-size:10px">${(e.actor_id||'').slice(0,12)}â€¦</code>${e.details ? ' Â· '+escapeHtml(e.details) : ''}</div>
        </div>
      </div>
      <div class="time">${timeAgo(e.created_at)}</div>
    </div>`;
  }).join('');
}
function clearAuditFilters(){
  document.getElementById('audit-filter-type').value='';
  document.getElementById('audit-filter-date').value='';
  filterAuditEvents();
}
function eventTypeBadge(type){
  const map = {
    login_success: {icon:'ğŸ”‘',label:'auth',cls:'running'},
    tenant_created: {icon:'â•',label:'create',cls:'running'},
    tenant_started: {icon:'â–¶ï¸',label:'action',cls:'running'},
    tenant_stopped: {icon:'â¹ï¸',label:'action',cls:'stopped'},
    tenant_deleted: {icon:'ğŸ—‘ï¸',label:'delete',cls:'error'},
    tenant_restarted: {icon:'ğŸ”„',label:'action',cls:'running'},
    tenant_pairing_reset: {icon:'ğŸ”‘',label:'security',cls:'running'},
    channel_configured: {icon:'ğŸ“±',label:'channel',cls:'running'},
    channel_deleted: {icon:'ğŸ“±',label:'channel',cls:'error'},
    config_updated: {icon:'âš™ï¸',label:'config',cls:'running'},
    agent_upserted: {icon:'ğŸ¤–',label:'agent',cls:'running'},
    agent_deleted: {icon:'ğŸ¤–',label:'agent',cls:'error'},
    user_created: {icon:'ğŸ‘¤',label:'user',cls:'running'},
    user_deleted: {icon:'ğŸ‘¤',label:'user',cls:'error'},
    pairing_success: {icon:'ğŸ”—',label:'pairing',cls:'running'},
  };
  return map[type] || {icon:'ğŸ“',label:'event',cls:'stopped'};
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCreateModal(){document.getElementById('modal-create').classList.remove('hidden')}
function hideModal(id){document.getElementById(id).classList.add('hidden')}

async function createTenant(){
  const btn = document.getElementById('btn-create-tenant');
  btn.disabled = true;
  btn.textContent = "Creating...";
  try {
    const res = await authFetch(API+'/tenants',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        name:document.getElementById('f-name').value,
        slug:document.getElementById('f-slug').value,
        provider:document.getElementById('f-provider').value,
        model:document.getElementById('f-model').value,
        plan:"free"
      })
    });
    const r = await res.json();
    if(r.ok) {
      hideModal('modal-create');toast('âœ… Tenant created!');loadPage();
    } else {
      toast('âŒ ' + (r.error || 'Failed to create tenant'), 'error');
    }
  } catch(e) {
    toast('âŒ ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = "Create";
  }
}

async function tenantAction(id,action){
  const confirms = {
    delete: 'Delete this tenant permanently? All data will be lost.',
    stop: 'Stop this tenant? Connected channels will disconnect.',
    restart: 'Restart this tenant? Brief downtime expected.',
  };
  if(confirms[action] && !confirm(confirms[action])) return;
  const method=action==='delete'?'DELETE':'POST';
  const url=action==='delete'?`${API}/tenants/${id}`:`${API}/tenants/${id}/${action}`;
  try {
    const r=await(await authFetch(url,{method})).json();
    if(r.ok){
      toast('âœ… Tenant '+action+'ed');
      setTimeout(()=>loadPage(), 300);
    } else {
      toast('âŒ '+(r.error||'Failed'), 'error');
    }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}
function logout(){localStorage.removeItem('bizclaw_admin_token');authToken='';showLogin();}

// â”€â”€ Tenant Detail Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let detailTenantId = '';
let detailTenantData = {};

function openTenantDetail(id, name, slug, provider, model, status, plan, pairing, port) {
  detailTenantId = id;
  detailTenantData = {id, name, slug, provider, model, status, plan, pairing, port};
  channelTenantId = id;
  channelTenantName = name;

  // Push URL for this tenant detail
  // Use hash-based route for tenant detail
  window.location.hash = '#/tenants/' + id;

  document.getElementById('detail-tenant-name').textContent = name;

  // Stats
  const baseDomain = location.hostname.replace(/^(admin|apps)\./, '');
  const proto = location.protocol;
  document.getElementById('detail-stats').innerHTML =
    `<div class="stat"><label>Status</label><div class="val ${status==='running'?'green':'red'}">${status}</div></div>`+
    `<div class="stat"><label>Provider</label><div class="val">${provider}</div></div>`+
    `<div class="stat"><label>Model</label><div class="val">${model}</div></div>`+
    `<div class="stat"><label>Port</label><div class="val">${port||'â€”'}</div></div>`;

  // Info card
  document.getElementById('detail-info').innerHTML = `
    <h3 style="margin-bottom:12px">ğŸ“‹ Tenant Info</h3>
    <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:14px">
      <span style="color:var(--muted)">ID:</span><code style="font-size:12px">${id}</code>
      <span style="color:var(--muted)">Slug:</span><span>${slug}</span>
      <span style="color:var(--muted)">URL:</span><a href="${proto}//${slug}.${baseDomain}" target="_blank" style="color:var(--accent)">${slug}.${baseDomain}</a>
      <span style="color:var(--muted)">Pairing:</span><strong style="color:var(--yellow)">${pairing||'N/A'}</strong>
    </div>
    <div style="margin-top:15px;display:flex;gap:8px">
      ${status!=='running'
        ?`<button class="btn btn-primary btn-sm" onclick="tenantAction('${id}','start');setTimeout(()=>showPage('tenants'),500)">â–¶ Start</button>`
        :`<button class="btn btn-outline btn-sm" onclick="tenantAction('${id}','stop');setTimeout(()=>showPage('tenants'),500)">â¹ Stop</button>`}
      <button class="btn btn-outline btn-sm" onclick="tenantAction('${id}','restart');toast('Restarting...')">ğŸ”„ Restart</button>
      <button class="btn btn-outline btn-sm" onclick="resetTenantPairing('${id}')">ğŸ”‘ Reset Pairing</button>
    </div>
  `;

  // Show detail page
  showPage('tenant-detail');
  showDetailTab('overview', document.querySelector('.detail-tab'));

  // Preload channels for channels tab
  loadDetailChannels(id);
  loadDetailModels();
}

function showDetailTab(tab, btn) {
  ['overview','settings','agents','channels','model'].forEach(t => {
    const el = document.getElementById('detail-tab-'+t);
    if(el) el.classList.toggle('hidden', t!==tab);
  });
  document.querySelectorAll('.detail-tab').forEach(b => {
    b.className = 'btn btn-outline btn-sm detail-tab';
  });
  if(btn) {
    btn.className = 'btn btn-primary btn-sm detail-tab active';
  }
  if(tab==='settings') loadTenantConfig();
  if(tab==='agents') loadTenantAgents();
}

async function loadDetailChannels(tenantId) {
  const res = await authFetch(`${API}/tenants/${tenantId}/channels`);
  const data = await res.json();
  const existing = {};
  if(data.ok && data.channels){
    data.channels.forEach(ch => {
      try { existing[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
      catch { existing[ch.channel_type] = { ...ch, config: {} }; }
    });
  }
  loadedChannels = existing;
  renderDetailChannelCards();
}

function renderDetailChannelCards() {
  const grid = document.getElementById('detail-ch-grid');
  grid.innerHTML = CHANNEL_DEFS.map(def => {
    const saved = loadedChannels[def.type];
    const enabled = saved ? saved.enabled : false;
    const status = saved ? saved.status : 'disconnected';
    const config = saved ? saved.config : {};
    return `<div class="ch-card" id="ch-${def.type}">
      <div class="ch-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="ch-icon">${def.icon}</span>
          <span class="ch-name">${def.name}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge ${status}" style="font-size:10px">${status}</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-${def.type}" ${enabled?'checked':''} onchange="toggleChannel('${def.type}',this.checked)">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          const val = config[f.key] || '';
          if(f.type==='textarea') return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${val}</textarea>`;
          if(f.type==='password') return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="password" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
          return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="text" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ LÆ°u</button>
        ${def.hasQR ? `<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t QR</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function loadDetailModels() {
  const info = document.getElementById('detail-model-info');
  const list = document.getElementById('detail-models-list');
  const t = detailTenantData;
  info.innerHTML = `
    <div style="display:grid;grid-template-columns:140px 1fr;gap:8px;font-size:14px">
      <span style="color:var(--muted)">Current Provider:</span><strong>${t.provider}</strong>
      <span style="color:var(--muted)">Current Model:</span><strong style="color:var(--accent)">${t.model}</strong>
      <span style="color:var(--muted)">Ollama Host:</span><span style="font-size:12px">Shared â€” configured in platform env (OLLAMA_HOST)</span>
    </div>
  `;

  // Fetch shared Ollama models
  try {
    const r = await(await authFetch(API+'/ollama/models')).json();
    if(r.ok && r.models && r.models.length > 0) {
      list.innerHTML = r.models.map(m => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border)">
          <div>
            <strong style="color:var(--accent)">${m.name}</strong>
            <span style="color:var(--muted);font-size:12px;margin-left:8px">${m.size} Â· ${m.family||''} Â· ${m.parameter_size||''}</span>
          </div>
          <span style="font-size:12px;color:${t.model===m.name?'var(--green)':'var(--muted)'}">${t.model===m.name?'âœ… Active':'Available'}</span>
        </div>
      `).join('');
    } else {
      list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--muted)">
        <p>Ollama chÆ°a Ä‘Æ°á»£c cÃ i Ä‘áº·t hoáº·c chÆ°a cÃ³ model nÃ o.</p>
        <p style="font-size:12px;margin-top:6px">CÃ i Ä‘áº·t: <code>curl -fsSL https://ollama.ai/install.sh | sh</code></p>
        <p style="font-size:12px;margin-top:4px">Pull model: <code>ollama pull tinyllama</code></p>
        <p style="font-size:12px;margin-top:8px;color:var(--yellow)">ğŸ’¡ Hoáº·c dÃ¹ng cloud provider (OpenAI, Anthropic, Gemini) thay cho Ollama</p>
      </div>`;
    }
  } catch(e) {
    list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--red)">âŒ Cannot connect to Ollama</div>`;
  }
}

async function resetTenantPairing(id) {
  try {
    const r = await(await authFetch(`${API}/tenants/${id}/pairing`, {method:'POST'})).json();
    if(r.ok) { toast(`âœ… New pairing code: ${r.pairing_code}`); }
    else { toast(`âŒ ${r.error}`, 'error'); }
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ CHANNEL CONFIGURATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CHANNEL_DEFS = [
  {
    type:'telegram', icon:'ğŸ¤–', name:'Telegram Bot', color:'#229ED9',
    fields:[
      {key:'bot_token', label:'Bot Token', placeholder:'123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11', type:'password'},
      {key:'allowed_chat_ids', label:'Allowed Chat IDs (comma-separated)', placeholder:'-100123456789, 987654321', type:'text'},
    ]
  },
  {
    type:'zalo', icon:'ğŸ’¬', name:'Zalo Personal', color:'#0068FF',
    fields:[
      {key:'cookie', label:'Zalo Cookie', placeholder:'zpw_sek=...; zpw_enk=...', type:'textarea'},
      {key:'imei', label:'IMEI (Device ID)', placeholder:'Auto-generated if empty', type:'text'},
    ],
    hasQR: true
  },
  {
    type:'discord', icon:'ğŸ®', name:'Discord Bot', color:'#5865F2',
    fields:[
      {key:'bot_token', label:'Bot Token', placeholder:'MTA0Nz...', type:'password'},
      {key:'allowed_channel_ids', label:'Allowed Channel IDs (comma-separated)', placeholder:'1234567890, 0987654321', type:'text'},
    ]
  },
  {
    type:'email', icon:'ğŸ“§', name:'Email (IMAP/SMTP)', color:'#EA4335',
    fields:[
      {key:'imap_host', label:'IMAP Host', placeholder:'imap.gmail.com', type:'text'},
      {key:'imap_port', label:'IMAP Port', placeholder:'993', type:'text'},
      {key:'smtp_host', label:'SMTP Host', placeholder:'smtp.gmail.com', type:'text'},
      {key:'smtp_port', label:'SMTP Port', placeholder:'587', type:'text'},
      {key:'email', label:'Email Address', placeholder:'bot@example.com', type:'text'},
      {key:'password', label:'App Password', placeholder:'xxxx-xxxx-xxxx-xxxx', type:'password'},
    ]
  },
  {
    type:'webhook', icon:'ğŸ”—', name:'Webhook', color:'var(--orange)',
    fields:[
      {key:'url', label:'Webhook URL', placeholder:'https://example.com/webhook', type:'text'},
      {key:'secret', label:'Webhook Secret', placeholder:'your-secret-key', type:'password'},
    ]
  },
  {
    type:'whatsapp', icon:'ğŸ“±', name:'WhatsApp Business', color:'#25D366',
    fields:[
      {key:'api_token', label:'API Token', placeholder:'EAAxxxxxx...', type:'password'},
      {key:'phone_number_id', label:'Phone Number ID', placeholder:'123456789', type:'text'},
      {key:'business_id', label:'Business ID', placeholder:'987654321', type:'text'},
    ]
  },
];

// Store loaded channel configs
let loadedChannels = {};

async function openChannels(tenantId, tenantName){
  channelTenantId = tenantId;
  channelTenantName = tenantName;
  document.getElementById('ch-tenant-name').textContent = tenantName;

  // Load existing channels from API
  const res = await authFetch(`${API}/tenants/${tenantId}/channels`);
  const data = await res.json();
  const existing = {};
  if(data.ok && data.channels){
    data.channels.forEach(ch => {
      try { existing[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
      catch { existing[ch.channel_type] = { ...ch, config: {} }; }
    });
  }
  loadedChannels = existing;

  // Render channel cards
  renderChannelCards();
  document.getElementById('modal-channels').classList.remove('hidden');
}

function renderChannelCards(){
  const grid = document.getElementById('ch-grid');
  grid.innerHTML = CHANNEL_DEFS.map(def => {
    const saved = loadedChannels[def.type];
    const enabled = saved ? saved.enabled : false;
    const status = saved ? saved.status : 'disconnected';
    const config = saved ? saved.config : {};

    return `<div class="ch-card" id="ch-${def.type}">
      <div class="ch-header">
        <div style="display:flex;align-items:center;gap:8px">
          <span class="ch-icon">${def.icon}</span>
          <span class="ch-name">${def.name}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="badge ${status}" style="font-size:10px">${status}</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-${def.type}" ${enabled?'checked':''} onchange="toggleChannel('${def.type}',this.checked)">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <div class="ch-fields">
        ${def.fields.map(f => {
          const val = config[f.key] || '';
          if(f.type==='textarea'){
            return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
              <textarea id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}">${val}</textarea>`;
          }
          if(f.type==='password'){
            return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
              <input type="password" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
          }
          return `<label style="font-size:11px;color:var(--muted);margin-top:6px">${f.label}</label>
            <input type="text" id="ch-${def.type}-${f.key}" placeholder="${f.placeholder}" value="${val}">`;
        }).join('')}
      </div>
      <div class="ch-actions">
        <button class="btn btn-primary btn-sm" onclick="saveChannel('${def.type}')">ğŸ’¾ LÆ°u</button>
        ${def.hasQR ? `<button class="btn btn-green btn-sm" onclick="openZaloQR()">ğŸ“± QuÃ©t QR</button>` : ''}
        ${saved ? `<button class="btn btn-danger btn-sm" onclick="removeChannel('${def.type}','${saved.id}')">âœ• XoÃ¡</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function saveChannel(type){
  const def = CHANNEL_DEFS.find(d=>d.type===type);
  if(!def) return;

  const config = {};
  def.fields.forEach(f => {
    const el = document.getElementById(`ch-${type}-${f.key}`);
    if(el) config[f.key] = el.value;
  });

  const enabled = document.getElementById(`toggle-${type}`).checked;

  const res = await authFetch(`${API}/tenants/${channelTenantId}/channels`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ channel_type: type, enabled, config })
  });
  const data = await res.json();
  if(data.ok){
    toast(`${def.name} â€” ÄÃ£ lÆ°u cáº¥u hÃ¬nh!`);
    // Reload
    const r2 = await authFetch(`${API}/tenants/${channelTenantId}/channels`);
    const d2 = await r2.json();
    loadedChannels = {};
    if(d2.ok && d2.channels){
      d2.channels.forEach(ch => {
        try { loadedChannels[ch.channel_type] = { ...ch, config: JSON.parse(ch.config_json) }; }
        catch { loadedChannels[ch.channel_type] = { ...ch, config: {} }; }
      });
    }
    renderChannelCards();
  } else {
    toast(data.error || 'Lá»—i lÆ°u cáº¥u hÃ¬nh', 'error');
  }
}

async function toggleChannel(type, enabled){
  // Auto-save toggle state
  const def = CHANNEL_DEFS.find(d=>d.type===type);
  if(!def) return;

  const config = {};
  def.fields.forEach(f => {
    const el = document.getElementById(`ch-${type}-${f.key}`);
    if(el) config[f.key] = el.value;
  });

  await authFetch(`${API}/tenants/${channelTenantId}/channels`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ channel_type: type, enabled, config })
  });
  toast(`${def.name} â€” ${enabled?'ÄÃ£ báº­t':'ÄÃ£ táº¯t'}`);
}

async function removeChannel(type, channelId){
  if(!confirm('XoÃ¡ cáº¥u hÃ¬nh kÃªnh nÃ y?')) return;
  await authFetch(`${API}/tenants/${channelTenantId}/channels/${channelId}`, {method:'DELETE'});
  delete loadedChannels[type];
  renderChannelCards();
  toast('ÄÃ£ xoÃ¡ kÃªnh');
}

// â”€â”€ Zalo QR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openZaloQR(){
  document.getElementById('modal-zalo-qr').classList.remove('hidden');
  document.getElementById('qr-display').innerHTML = '<p style="color:var(--muted)">â³ Äang táº¡o mÃ£ QR...</p>';
  document.getElementById('zalo-cookie-input').value = '';

  try {
    const res = await authFetch(`${API}/tenants/${channelTenantId}/channels/zalo/qr`, {method:'POST'});
    const data = await res.json();
    if(data.ok && data.qr_code){
      document.getElementById('qr-display').innerHTML = `
        <img src="${data.qr_code}" alt="Zalo QR Code" style="max-width:200px;border:2px solid var(--accent);border-radius:8px">
        <p style="margin-top:8px;font-size:12px;color:var(--muted)">${data.message || 'Má»Ÿ Zalo â†’ QuÃ©t mÃ£ QR'}</p>
      `;
    } else {
      document.getElementById('qr-display').innerHTML = `
        <p style="color:var(--yellow)">âš ï¸ ${data.error || 'KhÃ´ng láº¥y Ä‘Æ°á»£c QR'}</p>
        <p style="font-size:12px;color:var(--muted);margin-top:6px">${data.fallback || 'Vui lÃ²ng paste cookie bÃªn dÆ°á»›i'}</p>
      `;
    }
  } catch(e) {
    document.getElementById('qr-display').innerHTML = `
      <p style="color:var(--yellow)">âš ï¸ Lá»—i káº¿t ná»‘i Ä‘áº¿n server</p>
      <p style="font-size:12px;color:var(--muted);margin-top:6px">Vui lÃ²ng paste cookie Zalo Web bÃªn dÆ°á»›i</p>
    `;
  }
}

async function saveZaloCookie(){
  const cookie = document.getElementById('zalo-cookie-input').value.trim();
  if(!cookie){
    toast('Vui lÃ²ng nháº­p cookie Zalo', 'error');
    return;
  }

  // Save cookie to Zalo channel config
  const el = document.getElementById('ch-zalo-cookie');
  if(el) el.value = cookie;

  // Auto-save
  await saveChannel('zalo');
  hideModal('modal-zalo-qr');
  toast('âœ… Cookie Zalo Ä‘Ã£ Ä‘Æ°á»£c lÆ°u!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ OLLAMA / BRAIN ENGINE MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadOllama(){
  await ollamaHealth();
  await ollamaListModels();
}

async function ollamaHealth(){
  try{
    const r=await(await authFetch(API+'/ollama/health')).json();
    const el=document.getElementById('ollama-status');
    const card=document.getElementById('ollama-health-card');
    document.getElementById('ollama-url').textContent=r.url||'â€”';
    if(r.ok){
      el.textContent='â— Running';el.style.color='var(--green)';
    }else{
      el.innerHTML=`<span style="color:var(--red)">âœ• ${r.status||'Not Running'}</span>`;
      if(r.install_guide){
        el.innerHTML+=`<div style="font-size:11px;color:var(--muted);margin-top:6px">Install: <code>${r.install_guide}</code></div>`;
      }
    }
  }catch(e){
    document.getElementById('ollama-status').innerHTML='<span style="color:var(--red)">âœ• Error</span>';
  }
}

async function ollamaListModels(){
  try{
    const r=await(await authFetch(API+'/ollama/models')).json();
    const tbody=document.getElementById('ollama-models');
    const empty=document.getElementById('ollama-empty');
    if(!r.ok||!r.models||r.models.length===0){
      tbody.innerHTML='';empty.style.display='block';
      document.getElementById('ollama-count').textContent='0';
      return;
    }
    empty.style.display='none';
    document.getElementById('ollama-count').textContent=r.models.length;
    tbody.innerHTML=r.models.map(m=>`<tr>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)"><strong style="color:var(--accent)">${m.name}</strong></td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.size}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.family||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.parameter_size||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border)">${m.quantization||'â€”'}</td>
      <td style="padding:10px 8px;border-bottom:1px solid var(--border);text-align:right">
        <button class="btn btn-danger btn-sm" onclick="ollamaDeleteModel('${m.name}')">âœ• Delete</button>
      </td>
    </tr>`).join('');
  }catch(e){
    document.getElementById('ollama-models').innerHTML='';
    document.getElementById('ollama-empty').style.display='block';
  }
}

async function pullModel(){
  const custom=document.getElementById('pull-model-custom').value.trim();
  const select=document.getElementById('pull-model-name').value;
  const model=custom||select;
  if(!model){toast('Chá»n hoáº·c nháº­p tÃªn model','error');return;}

  const btn=document.getElementById('pull-btn');
  const status=document.getElementById('pull-status');
  btn.disabled=true;btn.textContent='â³ Downloading...';
  status.style.display='block';status.textContent=`Downloading ${model}... This may take several minutes.`;

  try{
    const r=await(await authFetch(API+'/ollama/pull',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model})})).json();
    if(r.ok){
      toast(`âœ… ${r.message||'Model pulled!'}`);
      status.textContent=`âœ… ${model} pulled successfully!`;status.style.color='var(--green)';
      await ollamaListModels();
    }else{
      toast(`âŒ ${r.error||'Pull failed'}`,'error');
      status.textContent=`âŒ ${r.error||'Failed'}`;status.style.color='var(--red)';
    }
  }catch(e){
    toast('âŒ '+e.message,'error');
    status.textContent='âŒ '+e.message;status.style.color='var(--red)';
  }finally{
    btn.disabled=false;btn.textContent='ğŸ“¥ Pull';
    setTimeout(()=>{status.style.display='none';status.style.color='var(--muted)';},5000);
  }
}

async function ollamaDeleteModel(name){
  if(!confirm(`XoÃ¡ model "${name}"?`))return;
  try{
    const r=await(await authFetch(API+'/ollama/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:name})})).json();
    if(r.ok){toast(`âœ… ${r.message}`);await ollamaListModels();}
    else{toast(`âŒ ${r.error||'Delete failed'}`,'error');}
  }catch(e){toast('âŒ '+e.message,'error');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ TENANT CONFIG (SETTINGS TAB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTenantConfig() {
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/configs`)).json();
    if(r.ok && r.configs) {
      const c = r.configs;
      const setVal = (id, key) => { const el=document.getElementById(id); if(el) el.value=c[key]||''; };
      setVal('cfg-provider','default_provider');
      setVal('cfg-model','default_model');
      setVal('cfg-api-key','api_key');
      setVal('cfg-api-url','api_base_url');
      setVal('cfg-identity-name','identity.name');
      setVal('cfg-identity-persona','identity.persona');
      setVal('cfg-identity-prompt','identity.system_prompt');
      // Set select dropdown
      const sel = document.getElementById('cfg-provider');
      if(sel && c.default_provider) {
        for(let i=0;i<sel.options.length;i++) {
          if(sel.options[i].value===c.default_provider) { sel.selectedIndex=i; break; }
        }
      }
    }
  } catch(e) { console.error('Load config error:', e); }
}

async function saveTenantConfig() {
  const configs = {
    default_provider: document.getElementById('cfg-provider').value,
    default_model: document.getElementById('cfg-model').value,
    api_key: document.getElementById('cfg-api-key').value,
    api_base_url: document.getElementById('cfg-api-url').value,
    'identity.name': document.getElementById('cfg-identity-name').value,
    'identity.persona': document.getElementById('cfg-identity-persona').value,
    'identity.system_prompt': document.getElementById('cfg-identity-prompt').value,
  };
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/configs`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({configs})
    })).json();
    if(r.ok) {
      toast(`âœ… Settings saved (${r.saved} keys)`);
      document.getElementById('cfg-save-status').textContent = 'âœ… Saved!';
      setTimeout(() => document.getElementById('cfg-save-status').textContent = '', 3000);
    } else {
      toast(r.error||'Save failed', 'error');
    }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ TENANT AGENTS (AGENTS TAB) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showAddAgentForm() {
  document.getElementById('add-agent-form').classList.remove('hidden');
  document.getElementById('ag-name').value = '';
  document.getElementById('ag-role').value = 'assistant';
  document.getElementById('ag-desc').value = '';
  document.getElementById('ag-prompt').value = '';
}

async function loadTenantAgents() {
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents`)).json();
    const list = document.getElementById('agents-list');
    if(r.ok && r.agents && r.agents.length > 0) {
      list.innerHTML = r.agents.map(a => `
        <div class="card" style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong style="color:var(--accent)">${escapeHtml(a.name)}</strong>
              <span class="badge running" style="margin-left:8px">${escapeHtml(a.role)}</span>
              <span style="margin-left:8px">${providerBadge(a.provider,a.model)}</span>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn btn-danger btn-sm" onclick="deleteTenantAgent('${esc(a.name)}')" title="Delete agent">âœ•</button>
            </div>
          </div>
          ${a.description ? `<div style="font-size:12px;color:var(--muted);margin-top:6px">${escapeHtml(a.description)}</div>` : ''}
          ${a.system_prompt ? `<div style="font-size:11px;color:var(--muted);margin-top:4px;font-family:monospace;max-height:40px;overflow:hidden;text-overflow:ellipsis">ğŸ“ ${escapeHtml(a.system_prompt.slice(0,120))}${a.system_prompt.length>120?'...':''}</div>` : ''}
        </div>
      `).join('');
    } else {
      list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><p>ğŸ‘» ChÆ°a cÃ³ agent nÃ o.</p><p style="font-size:12px;margin-top:4px">Nháº¥n "+ ThÃªm Agent" Ä‘á»ƒ táº¡o agent má»›i.</p></div>';
    }
  } catch(e) { console.error('Load agents error:', e); }
}

async function createTenantAgent() {
  const body = {
    name: document.getElementById('ag-name').value.trim(),
    role: document.getElementById('ag-role').value.trim() || 'assistant',
    description: document.getElementById('ag-desc').value.trim(),
    provider: document.getElementById('ag-provider').value,
    model: document.getElementById('ag-model').value.trim(),
    system_prompt: document.getElementById('ag-prompt').value.trim(),
  };
  if(!body.name) { toast('Nháº­p tÃªn agent', 'error'); return; }
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    })).json();
    if(r.ok) {
      toast(`âœ… Agent "${body.name}" created!`);
      document.getElementById('add-agent-form').classList.add('hidden');
      loadTenantAgents();
    } else { toast(r.error||'Create failed', 'error'); }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

async function deleteTenantAgent(name) {
  if(!confirm(`XoÃ¡ agent "${name}"?`)) return;
  try {
    const r = await(await authFetch(`${API}/tenants/${detailTenantId}/agents/${encodeURIComponent(name)}`, {method:'DELETE'})).json();
    if(r.ok) { toast(`âœ… Agent "${name}" deleted`); loadTenantAgents(); }
    else { toast(r.error||'Delete failed', 'error'); }
  } catch(e) { toast('âŒ '+e.message, 'error'); }
}

// â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', (e) => {
  // Escape â†’ close any open modal
  if(e.key==='Escape'){
    document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(m=>m.classList.add('hidden'));
  }
  // Ctrl/Cmd+K â†’ focus tenant search
  if((e.ctrlKey||e.metaKey) && e.key==='k'){
    e.preventDefault();
    if(currentPage!=='tenants') showPage('tenants');
    setTimeout(()=>{
      const s=document.getElementById('tenant-search');
      if(s) s.focus();
    },100);
  }
});

// â”€â”€ Agent Teams / Workflows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const TEAM_TEMPLATES = [
  {
    id: 'feature-dev', cls: 'tpl-feat', icon: 'ğŸš€', title: 'Feature Development',
    agents: 5,
    desc: 'Tá»« yÃªu cáº§u â†’ code Ä‘Ã£ test + review. Planner chia nhá» stories, Developer implement, Verifier kiá»ƒm tra, Tester viáº¿t tests, Reviewer code review.',
    pipeline: ['Plan', 'Implement', 'Verify', 'Test', 'Review'],
    roles: [
      { icon: 'ğŸ§ ', name: 'Planner', type: 'analysis', desc: 'PhÃ¢n tÃ­ch yÃªu cáº§u, táº¡o stories' },
      { icon: 'ğŸ’»', name: 'Developer', type: 'coding', desc: 'Implement code cho tá»«ng story' },
      { icon: 'ğŸ”', name: 'Verifier', type: 'verification', desc: 'Verify theo acceptance criteria' },
      { icon: 'ğŸ§ª', name: 'Tester', type: 'testing', desc: 'Viáº¿t vÃ  cháº¡y tests' },
      { icon: 'ğŸ“', name: 'Reviewer', type: 'analysis', desc: 'Code review cuá»‘i cÃ¹ng' }
    ]
  },
  {
    id: 'bug-fix', cls: 'tpl-bug', icon: 'ğŸ›', title: 'Bug Fix Pipeline',
    agents: 4,
    desc: 'Paste bug report â†’ nháº­n fix + regression test. Triager reproduce, Investigator tÃ¬m root cause, Fixer patch, Verifier confirm.',
    pipeline: ['Triage', 'Investigate', 'Fix', 'Verify'],
    roles: [
      { icon: 'ğŸ”¬', name: 'Triager', type: 'analysis', desc: 'Reproduce bug, xÃ¡c nháº­n' },
      { icon: 'ğŸ•µï¸', name: 'Investigator', type: 'analysis', desc: 'TÃ¬m root cause' },
      { icon: 'ğŸ”§', name: 'Fixer', type: 'coding', desc: 'Patch code + regression test' },
      { icon: 'âœ…', name: 'Verifier', type: 'verification', desc: 'XÃ¡c nháº­n fix hoáº¡t Ä‘á»™ng' }
    ]
  },
  {
    id: 'security-audit', cls: 'tpl-sec', icon: 'ğŸ›¡ï¸', title: 'Security Audit',
    agents: 4,
    desc: 'QuÃ©t repo â†’ patch vulnerabilities + regression tests. Scanner tÃ¬m lá»— há»•ng, Prioritizer xáº¿p háº¡ng severity, Fixer patch, Verifier re-audit.',
    pipeline: ['Scan', 'Prioritize', 'Fix', 'Re-Audit'],
    roles: [
      { icon: 'ğŸ“¡', name: 'Scanner', type: 'scanning', desc: 'QuÃ©t CVE, OWASP top 10' },
      { icon: 'âš–ï¸', name: 'Prioritizer', type: 'analysis', desc: 'Xáº¿p háº¡ng severity' },
      { icon: 'ğŸ”', name: 'Fixer', type: 'coding', desc: 'Patch vulnerabilities' },
      { icon: 'ğŸ”', name: 'Re-Auditor', type: 'verification', desc: 'Kiá»ƒm tra láº¡i sau fix' }
    ]
  },
  {
    id: 'content-create', cls: 'tpl-content', icon: 'âœï¸', title: 'Content Creation',
    agents: 4,
    desc: 'Research â†’ Draft â†’ Edit â†’ Publish. Researcher thu tháº­p data, Writer viáº¿t bÃ i, Editor chá»‰nh sá»­a, Publisher format final.',
    pipeline: ['Research', 'Draft', 'Edit', 'Publish'],
    roles: [
      { icon: 'ğŸ”', name: 'Researcher', type: 'analysis', desc: 'Thu tháº­p thÃ´ng tin, data' },
      { icon: 'âœï¸', name: 'Writer', type: 'coding', desc: 'Viáº¿t ná»™i dung' },
      { icon: 'ğŸ“', name: 'Editor', type: 'verification', desc: 'Chá»‰nh sá»­a, kiá»ƒm duyá»‡t' },
      { icon: 'ğŸ“¢', name: 'Publisher', type: 'coding', desc: 'Format vÃ  xuáº¥t báº£n' }
    ]
  },
  {
    id: 'code-review', cls: 'tpl-review', icon: 'ğŸ”¬', title: 'Code Review Pipeline',
    agents: 3,
    desc: 'Analyze â†’ Security check â†’ Performance review. 3 chuyÃªn gia phÃ¢n tÃ­ch code tá»« nhiá»u gÃ³c Ä‘á»™ rá»“i tá»•ng há»£p.',
    pipeline: ['Analyze', 'Security', 'Performance', 'Summary'],
    roles: [
      { icon: 'ğŸ—ï¸', name: 'Architect', type: 'analysis', desc: 'ÄÃ¡nh giÃ¡ kiáº¿n trÃºc, patterns' },
      { icon: 'ğŸ”’', name: 'Security Expert', type: 'scanning', desc: 'Kiá»ƒm tra báº£o máº­t' },
      { icon: 'âš¡', name: 'Perf Analyst', type: 'analysis', desc: 'PhÃ¢n tÃ­ch performance' }
    ]
  },
  {
    id: 'customer-support', cls: 'tpl-support', icon: 'ğŸ’¬', title: 'Customer Support',
    agents: 3,
    desc: 'PhÃ¢n loáº¡i â†’ Tráº£ lá»i â†’ Escalate. Classifier phÃ¢n loáº¡i ticket, Responder soáº¡n cÃ¢u tráº£ lá»i, Escalator chuyá»ƒn tiáº¿p complex cases.',
    pipeline: ['Classify', 'Respond', 'Escalate'],
    roles: [
      { icon: 'ğŸ·ï¸', name: 'Classifier', type: 'analysis', desc: 'PhÃ¢n loáº¡i ticket' },
      { icon: 'ğŸ’', name: 'Responder', type: 'coding', desc: 'Soáº¡n cÃ¢u tráº£ lá»i' },
      { icon: 'ğŸ“', name: 'Escalator', type: 'analysis', desc: 'Chuyá»ƒn tiáº¿p phá»©c táº¡p' }
    ]
  }
];

// Installed teams storage
let installedTeams = JSON.parse(localStorage.getItem('bizclaw_teams') || '[]');
let workflowRuns = JSON.parse(localStorage.getItem('bizclaw_runs') || '[]');
let selectedTplId = null;

function saveTeamsState() {
  localStorage.setItem('bizclaw_teams', JSON.stringify(installedTeams));
  localStorage.setItem('bizclaw_runs', JSON.stringify(workflowRuns));
}

function loadTeams() {
  renderTemplateGallery();
  renderActiveTeams();
  renderWorkflowRuns();
  updateTeamStats();
}

function updateTeamStats() {
  document.getElementById('ts-active').textContent = installedTeams.length;
  document.getElementById('ts-runs').textContent = workflowRuns.length;
  const done = workflowRuns.filter(r => r.status === 'done').length;
  const total = workflowRuns.length;
  document.getElementById('ts-rate').textContent = total > 0 ? Math.round(done/total*100) + '%' : 'â€”';
}

function renderTemplateGallery() {
  const el = document.getElementById('tpl-gallery');
  el.innerHTML = TEAM_TEMPLATES.map(t => {
    const installed = installedTeams.find(it => it.id === t.id);
    const pipelineHtml = t.pipeline.map((s, i) => 
      `<span class="pipe-step">${s}</span>${i < t.pipeline.length - 1 ? '<span class="pipe-arrow">â†’</span>' : ''}`
    ).join('');
    return `
      <div class="team-tpl ${t.cls}" onclick="showTemplateDetail('${t.id}')">
        <div class="tpl-header">
          <span class="tpl-icon">${t.icon}</span>
          <span class="tpl-title">${t.title}</span>
          <span class="tpl-agents">${t.agents} agents</span>
        </div>
        <div class="tpl-desc">${t.desc}</div>
        <div class="tpl-pipeline">${pipelineHtml}</div>
        ${installed ? '<div style="margin-top:10px;font-size:11px;color:var(--green)">âœ… Installed</div>' : ''}
      </div>`;
  }).join('');
}

function showTemplateDetail(tplId) {
  const tpl = TEAM_TEMPLATES.find(t => t.id === tplId);
  if (!tpl) return;
  selectedTplId = tplId;
  
  document.getElementById('tpl-detail-title').textContent = `${tpl.icon} ${tpl.title}`;
  document.getElementById('tpl-detail-desc').textContent = tpl.desc;
  
  // Pipeline
  document.getElementById('tpl-detail-pipeline').innerHTML = tpl.pipeline.map((s, i) =>
    `<span class="run-step pending" style="padding:8px 16px;font-size:13px">${s}</span>${i < tpl.pipeline.length - 1 ? '<span class="run-arrow" style="font-size:14px;padding:0 6px">â†’</span>' : ''}`
  ).join('');
  
  // Agent roles
  document.getElementById('tpl-detail-agents').innerHTML = tpl.roles.map(r =>
    `<div class="agent-role-card">
      <span class="role-icon">${r.icon}</span>
      <div class="role-name">${r.name}</div>
      <div class="role-type">${r.desc}</div>
      <span class="role-access ${r.type}">${r.type}</span>
    </div>`
  ).join('');
  
  const installed = installedTeams.find(it => it.id === tplId);
  document.getElementById('btn-install-tpl').textContent = installed ? 'âœ… ÄÃ£ cÃ i Ä‘áº·t' : 'ğŸš€ CÃ i Ä‘áº·t Team';
  document.getElementById('btn-install-tpl').disabled = !!installed;
  
  document.getElementById('modal-team-detail').classList.remove('hidden');
}

function installTeamTemplate() {
  if (!selectedTplId) return;
  const tpl = TEAM_TEMPLATES.find(t => t.id === selectedTplId);
  if (!tpl) return;
  
  if (installedTeams.find(t => t.id === tpl.id)) {
    toast('Team Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t rá»“i', 'error');
    return;
  }
  
  installedTeams.push({
    id: tpl.id,
    title: tpl.title,
    icon: tpl.icon,
    agents: tpl.agents,
    pipeline: tpl.pipeline,
    roles: tpl.roles,
    installed_at: new Date().toISOString(),
    runs: 0
  });
  
  saveTeamsState();
  toast(`âœ… Team "${tpl.title}" Ä‘Ã£ cÃ i Ä‘áº·t thÃ nh cÃ´ng!`);
  hideModal('modal-team-detail');
  loadTeams();
}

function renderActiveTeams() {
  const el = document.getElementById('active-teams-list');
  if (installedTeams.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><p>ğŸœ ChÆ°a cÃ³ team nÃ o Ä‘Æ°á»£c cÃ i Ä‘áº·t.</p><p style="font-size:12px;margin-top:4px">Chá»n má»™t template á»Ÿ trÃªn Ä‘á»ƒ báº¯t Ä‘áº§u!</p></div>';
    return;
  }
  
  el.innerHTML = installedTeams.map(t => `
    <div class="active-team">
      <div class="team-info">
        <span class="team-icon">${t.icon}</span>
        <div>
          <div class="team-name">${escapeHtml(t.title)}</div>
          <div class="team-meta">${t.agents} agents Â· ${t.pipeline.join(' â†’ ')} Â· ${t.runs || 0} runs</div>
        </div>
      </div>
      <div class="team-actions">
        <button class="btn btn-primary btn-sm" onclick="showRunWorkflow('${t.id}')">â–¶ï¸ Run</button>
        <button class="btn btn-danger btn-sm" onclick="uninstallTeam('${t.id}')">âœ•</button>
      </div>
    </div>
  `).join('');
}

function uninstallTeam(teamId) {
  if (!confirm(`Gá»¡ cÃ i Ä‘áº·t team "${teamId}"?`)) return;
  installedTeams = installedTeams.filter(t => t.id !== teamId);
  saveTeamsState();
  toast(`ğŸ—‘ï¸ Team "${teamId}" Ä‘Ã£ gá»¡ cÃ i Ä‘áº·t`);
  loadTeams();
}

async function showRunWorkflow(teamId) {
  const team = installedTeams.find(t => t.id === teamId);
  if (!team) return;
  
  document.getElementById('run-team-name').textContent = team.title;
  document.getElementById('run-task-input').value = '';
  document.getElementById('run-task-input').dataset.teamId = teamId;
  
  // Populate tenant dropdown
  const sel = document.getElementById('run-tenant-select');
  sel.innerHTML = '<option value="">-- Chá»n tenant --</option>';
  try {
    const d = await(await authFetch(API+'/tenants')).json();
    (d.tenants||[]).forEach(t => {
      sel.innerHTML += `<option value="${t.id}">${escapeHtml(t.name)} (${t.slug})</option>`;
    });
  } catch(e) { console.error(e); }
  
  document.getElementById('modal-run-workflow').classList.remove('hidden');
}

function startWorkflowRun() {
  const task = document.getElementById('run-task-input').value.trim();
  const teamId = document.getElementById('run-task-input').dataset.teamId;
  const tenantId = document.getElementById('run-tenant-select').value;
  
  if (!task) { toast('Vui lÃ²ng nháº­p mÃ´ táº£ task', 'error'); return; }
  if (!tenantId) { toast('Vui lÃ²ng chá»n tenant', 'error'); return; }
  
  const team = installedTeams.find(t => t.id === teamId);
  if (!team) return;
  
  // Create a run record
  const runId = Math.random().toString(36).slice(2, 10);
  const run = {
    id: runId,
    team_id: teamId,
    team_title: team.title,
    team_icon: team.icon,
    task: task.slice(0, 100),
    status: 'running',
    steps: team.pipeline.map((s, i) => ({ name: s, status: i === 0 ? 'running' : 'pending' })),
    started_at: new Date().toISOString(),
    progress: 0
  };
  
  workflowRuns.unshift(run);
  
  // Update team run count
  const t = installedTeams.find(t => t.id === teamId);
  if (t) t.runs = (t.runs || 0) + 1;
  
  saveTeamsState();
  hideModal('modal-run-workflow');
  toast(`ğŸš€ Workflow "${team.title}" Ä‘ang cháº¡y! Run ID: ${runId}`);
  loadTeams();
  
  // Simulate steps completing over time
  simulateRun(runId);
}

function simulateRun(runId) {
  const run = workflowRuns.find(r => r.id === runId);
  if (!run) return;
  
  let stepIdx = 0;
  const interval = setInterval(() => {
    if (stepIdx >= run.steps.length) {
      clearInterval(interval);
      run.status = 'done';
      run.progress = 100;
      saveTeamsState();
      if (currentPage === 'teams') loadTeams();
      toast(`âœ… Workflow run ${runId} hoÃ n táº¥t!`);
      return;
    }
    
    // Complete current step
    run.steps[stepIdx].status = 'done';
    stepIdx++;
    
    // Mark next step as running
    if (stepIdx < run.steps.length) {
      run.steps[stepIdx].status = 'running';
    }
    
    run.progress = Math.round((stepIdx / run.steps.length) * 100);
    saveTeamsState();
    if (currentPage === 'teams') renderWorkflowRuns();
  }, 2000 + Math.random() * 2000);
}

function renderWorkflowRuns() {
  const el = document.getElementById('workflow-runs');
  if (workflowRuns.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><p>ğŸ“Š ChÆ°a cÃ³ workflow run nÃ o.</p><p style="font-size:12px;margin-top:4px">CÃ i Ä‘áº·t team rá»“i cháº¡y má»™t workflow Ä‘á»ƒ báº¯t Ä‘áº§u!</p></div>';
    return;
  }
  
  el.innerHTML = workflowRuns.slice(0, 10).map(r => {
    const statusIcon = r.status === 'done' ? 'âœ…' : r.status === 'failed' ? 'âŒ' : 'ğŸ”„';
    const statusBadge = r.status === 'done' ? 'running' : r.status === 'failed' ? 'error' : 'connected';
    
    const stepsHtml = r.steps.map((s, i) => {
      const icon = s.status === 'done' ? 'âœ“' : s.status === 'running' ? 'âŸ³' : s.status === 'failed' ? 'âœ—' : 'â—‹';
      return `<span class="run-step ${s.status}">${icon} ${s.name}</span>${i < r.steps.length - 1 ? '<span class="run-arrow">â†’</span>' : ''}`;
    }).join('');
    
    return `
      <div class="run-card">
        <div class="run-header">
          <div>
            <span class="run-id">${r.team_icon} ${r.id}</span>
            <span class="badge ${statusBadge}" style="margin-left:8px">${r.status}</span>
          </div>
          <div style="font-size:11px;color:var(--muted)">${timeAgo(r.started_at)}</div>
        </div>
        <div style="font-size:13px;color:var(--text);margin-bottom:10px">ğŸ“‹ ${escapeHtml(r.task)}</div>
        <div class="run-steps">${stepsHtml}</div>
        <div class="run-progress"><div class="run-progress-bar" style="width:${r.progress}%"></div></div>
      </div>`;
  }).join('');
  
  updateTeamStats();
}

// Custom team builder
let customAgentCount = 0;

function showCreateTeamModal() {
  customAgentCount = 0;
  document.getElementById('ct-name').value = '';
  document.getElementById('ct-desc').value = '';
  document.getElementById('ct-agents-list').innerHTML = '';
  addCustomAgent();
  addCustomAgent();
  document.getElementById('modal-create-team').classList.remove('hidden');
}

function addCustomAgent() {
  customAgentCount++;
  const n = customAgentCount;
  const el = document.getElementById('ct-agents-list');
  const div = document.createElement('div');
  div.id = `ct-agent-${n}`;
  div.style.cssText = 'background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px';
  div.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <select id="ct-icon-${n}" style="width:60px;padding:4px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:16px;text-align:center">
        <option>ğŸ§ </option><option>ğŸ’»</option><option>ğŸ”</option><option>ğŸ§ª</option><option>ğŸ“</option><option>ğŸ”§</option><option>ğŸ”¬</option><option>ğŸ“¡</option><option>ğŸ”</option><option>âœï¸</option><option>ğŸ’¬</option><option>âš¡</option>
      </select>
      <input id="ct-name-${n}" placeholder="Agent name" style="flex:1;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px">
      <select id="ct-role-${n}" style="width:120px;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px">
        <option value="analysis">ğŸ”µ Analysis</option>
        <option value="coding">ğŸŸ¢ Coding</option>
        <option value="verification">ğŸŸ¡ Verification</option>
        <option value="testing">ğŸŸ£ Testing</option>
        <option value="scanning">ğŸŸ  Scanning</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="document.getElementById('ct-agent-${n}').remove()" style="padding:4px 8px">âœ•</button>
    </div>
    <input id="ct-desc-${n}" placeholder="MÃ´ táº£ vai trÃ² agent..." style="width:100%;padding:6px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px">
  `;
  el.appendChild(div);
}

function createCustomTeam() {
  const name = document.getElementById('ct-name').value.trim();
  const desc = document.getElementById('ct-desc').value.trim();
  if (!name) { toast('Vui lÃ²ng nháº­p tÃªn team', 'error'); return; }
  
  // Collect agents
  const agents = [];
  const pipeline = [];
  document.querySelectorAll('[id^="ct-agent-"]').forEach(div => {
    const n = div.id.replace('ct-agent-', '');
    const agentName = document.getElementById(`ct-name-${n}`)?.value?.trim();
    if (!agentName) return;
    agents.push({
      icon: document.getElementById(`ct-icon-${n}`)?.value || 'ğŸ¤–',
      name: agentName,
      type: document.getElementById(`ct-role-${n}`)?.value || 'coding',
      desc: document.getElementById(`ct-desc-${n}`)?.value || ''
    });
    pipeline.push(agentName);
  });
  
  if (agents.length < 2) { toast('Team cáº§n Ã­t nháº¥t 2 agents', 'error'); return; }
  
  const teamId = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  
  installedTeams.push({
    id: teamId,
    title: name,
    icon: 'ğŸ—ï¸',
    agents: agents.length,
    pipeline: pipeline,
    roles: agents,
    installed_at: new Date().toISOString(),
    runs: 0,
    custom: true
  });
  
  saveTeamsState();
  hideModal('modal-create-team');
  toast(`âœ… Custom team "${name}" Ä‘Ã£ táº¡o thÃ nh cÃ´ng!`);
  loadTeams();
}

// â”€â”€ Platform health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkPlatformHealth(){
  try {
    const dot=document.getElementById('sidebar-health');
    if(!dot) return;
    const r=await authFetch(API+'/stats');
    if(r.ok) { dot.style.background='var(--green)'; dot.title='Platform healthy'; }
    else { dot.style.background='var(--red)'; dot.title='Platform error'; }
  } catch {
    const dot=document.getElementById('sidebar-health');
    if(dot) { dot.style.background='var(--red)'; dot.title='Platform unreachable'; }
  }
}
setInterval(checkPlatformHealth, 30000); // Check every 30s

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkAuth();
</script>
</body>
</html>
