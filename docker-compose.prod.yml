version: '3.8'

# ═══════════════════════════════════════════════════════════════
# BizClaw Production — Dual Domain + PostgreSQL + CoPaw Features
# bizclaw.vn + viagent.vn (independent instances)
# ═══════════════════════════════════════════════════════════════

services:
  # ── PostgreSQL Database ──
  postgres:
    image: postgres:16-alpine
    container_name: bizclaw-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: bizclaw
      POSTGRES_USER: bizclaw
      POSTGRES_PASSWORD: BizClaw@2026DB
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bizclaw"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - bizclaw-net

  # ── BizClaw Instance ──
  bizclaw:
    build: .
    container_name: bizclaw-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3001"    # Platform admin
      - "127.0.0.1:10001:10001"  # Tenant port 1
      - "127.0.0.1:10002:10002"  # Tenant port 2
      - "127.0.0.1:10003:10003"  # Tenant port 3
      - "127.0.0.1:10004:10004"  # Tenant port 4
      - "127.0.0.1:10005:10005"  # Tenant port 5
      - "127.0.0.1:10006:10006"  # Tenant port 6
      - "127.0.0.1:10007:10007"  # Tenant port 7
      - "127.0.0.1:10008:10008"  # Tenant port 8
      - "127.0.0.1:10009:10009"  # Tenant port 9
      - "127.0.0.1:10010:10010"  # Tenant port 10
    volumes:
      - bizclaw_data:/root/.bizclaw
      - nginx_dynamic:/etc/nginx/dynamic
    environment:
      - RUST_LOG=info
      - BIZCLAW_CONFIG=/root/.bizclaw/config.toml
      - BIZCLAW_CORS_ORIGINS=https://bizclaw.vn,https://apps.bizclaw.vn
      - BIZCLAW_BIND_ALL=1
      - DATABASE_URL=postgres://bizclaw:BizClaw@2026DB@postgres:5432/bizclaw
      - TZ=Asia/Ho_Chi_Minh
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - bizclaw-net

  # ── Viagent Instance (separate data, shared DB) ──
  viagent:
    build: .
    container_name: viagent-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:3002:3001"    # Platform admin (remapped)
      - "127.0.0.1:10011:10001"  # Tenant gateway 1
      - "127.0.0.1:10012:10002"  # Tenant gateway 2
    volumes:
      - viagent_data:/root/.bizclaw
    environment:
      - RUST_LOG=info
      - BIZCLAW_CONFIG=/root/.bizclaw/config.toml
      - BIZCLAW_CORS_ORIGINS=https://viagent.vn,https://apps.viagent.vn
      - BIZCLAW_BIND_ALL=1
      - DATABASE_URL=postgres://bizclaw:BizClaw@2026DB@postgres:5432/viagent
      - TZ=Asia/Ho_Chi_Minh
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - bizclaw-net

  # ── Nginx Reverse Proxy ──
  nginx:
    image: nginx:alpine
    container_name: bizclaw-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./landing:/var/www/bizclaw-landing:ro
      - ./deploy/viagent-landing:/var/www/viagent-landing:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
      - nginx_dynamic:/etc/nginx/dynamic:ro
    depends_on:
      - bizclaw
      - viagent
    networks:
      - bizclaw-net

  # ── Certbot (SSL) ──
  certbot:
    image: certbot/certbot
    container_name: bizclaw-certbot
    volumes:
      - certbot_data:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  pg_data:
    driver: local
  bizclaw_data:
    driver: local
  viagent_data:
    driver: local
  certbot_data:
    driver: local
  certbot_www:
    driver: local
  nginx_dynamic:
    driver: local

networks:
  bizclaw-net:
    driver: bridge
